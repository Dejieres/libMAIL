Version = 17
VersionRequired = 17
Checksum = -1733671395
Begin Form
    PopUp = NotDefault
    RecordSelectors = NotDefault
    AutoCenter = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    DefaultView = 0
    ScrollBars = 0
    ViewsAllowed = 1
    PictureAlignment = 2
    DatasheetGridlinesBehavior = 3
    Cycle = 1
    GridY = 10
    Width = 8107
    DatasheetFontHeight = 9
    ItemSuffix = 145
    Left = 2040
    Top = 1605
    Right = 11610
    Bottom = 11325
    DatasheetGridlinesColor = 12632256
    PaintPalette = Begin
        0x0003100000000000800000000080000080800000000080008000800000808000 ,
        0x80808000c0c0c000ff000000c0c0c000ffff00000000ff00c0c0c00000ffff00 ,
        0xffffff0000000000
    End
    OnUnload ="[Event Procedure]"
    RecSrcDt = Begin
        0x6c461a54537be340
    End
    Caption ="Courrier électronique"
    DatasheetFontName ="Arial"
    PrtMip = Begin
        0x8905000089050000890500008905000000000000201c0000e010000001000000 ,
        0x010000006801000000000000a10700000100000001000000
    End
    PrtDevMode = Begin
        0x687020627573696e65737320696e6b6a65742031313030207365726965730000 ,
        0x010421409c0064070fdf8007010009009a0b3408640001000700feff02000100 ,
        0x0000030000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000001000000 ,
        0x0300000001000000010000000000000000000000000000000000000042836587 ,
        0x0000000000000000000000000000008888080088880800888808000000000000 ,
        0x00000000340800009a0b0000016400000900000000ffffffff00000000000001 ,
        0x00070000000001014578706c6f72657200000000000000000000000000000000 ,
        0x0000000000000000000000000802000000000000000001010001000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000041007200 ,
        0x690061006c000000000000000000000000000000000000000000000000000000 ,
        0x00000000000000000000000000000000000000000000000000000000e0e0e000 ,
        0x480000001c020000000000004283658701ccdaba000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x000000000000000000ccdaba68007000200062007500730069006e0065007300 ,
        0x7300200069006e006b006a006500740020003100310030003000200073006500 ,
        0x7200690065007300000031003000300020007300650072006900650073002c00 ,
        0x4c006f00630061006c004f006e006c0079002c0044007200760043006f006e00 ,
        0x7600650072007400000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000010000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000
    End
    PrtDevNames = Begin
        0x080011003000010077696e73706f6f6c00687020627573696e65737320696e6b ,
        0x6a65742031313030207365726965730049505f3139322e3136382e302e323030 ,
        0x0000000000000000000000000000000000
    End
    OnResize ="[Event Procedure]"
    OnLoad ="[Event Procedure]"
    Begin
        Begin Label
            BackStyle = 0
        End
        Begin Rectangle
            SpecialEffect = 3
            BackStyle = 0
            Width = 850
            Height = 850
        End
        Begin Line
            Width = 1701
        End
        Begin Image
            BackStyle = 0
            OldBorderStyle = 0
            PictureAlignment = 2
            Width = 1701
            Height = 1701
        End
        Begin CommandButton
            Width = 1701
            Height = 283
            FontSize = 8
            FontWeight = 400
            ForeColor = -2147483630
            FontName ="MS Sans Serif"
        End
        Begin OptionButton
            SpecialEffect = 2
            LabelX = 230
            LabelY = -30
        End
        Begin CheckBox
            SpecialEffect = 2
            LabelX = 230
            LabelY = -30
        End
        Begin OptionGroup
            SpecialEffect = 3
            Width = 1701
            Height = 1701
        End
        Begin TextBox
            SpecialEffect = 2
            OldBorderStyle = 0
            Width = 1701
            LabelX = -1701
        End
        Begin ListBox
            SpecialEffect = 2
            Width = 1701
            Height = 1417
            LabelX = -1701
        End
        Begin ComboBox
            SpecialEffect = 2
            Width = 1701
            LabelX = -1701
        End
        Begin UnboundObjectFrame
            SpecialEffect = 2
            OldBorderStyle = 1
            Width = 4536
            Height = 2835
        End
        Begin ToggleButton
            Width = 283
            Height = 283
            FontSize = 8
            FontWeight = 400
            ForeColor = -2147483630
            FontName ="MS Sans Serif"
        End
        Begin Tab
            Width = 5103
            Height = 3402
        End
        Begin Page
            Width = 1701
            Height = 1701
        End
        Begin FormHeader
            Height = 1814
            BackColor = -2147483633
            Name ="EntêteFormulaire"
            Begin
                Begin TextBox
                    OverlapFlags = 87
                    AccessKey = 192
                    Left = 510
                    Top = 453
                    Width = 7490
                    Height = 283
                    TabIndex = 1
                    ForeColor = 128
                    Name ="txtA"
                    Format ="@;[Blue]\"Liste des destinataires\""
                    ValidationRule ="Like \"*?@?*.?*\""
                    FontName ="Arial"
                    ControlTipText ="Liste des destinataires, séparés par des point-virgules."
                    Begin
                        Begin Label
                            OverlapFlags = 93
                            Left = 113
                            Top = 453
                            Width = 397
                            Height = 226
                            Name ="Étiquette1"
                            Caption ="&À :"
                            FontName ="Arial"
                        End
                    End
                End
                Begin TextBox
                    OverlapFlags = 87
                    AccessKey = 67
                    Left = 510
                    Top = 793
                    Width = 7490
                    Height = 283
                    TabIndex = 2
                    ForeColor = 128
                    Name ="txtCC"
                    Format ="@;[Blue]\"Destinataires en copie\""
                    FontName ="Arial"
                    ControlTipText ="Liste des destinataires en copie, séparés par des point-virgules."
                    Begin
                        Begin Label
                            OverlapFlags = 93
                            Left = 113
                            Top = 793
                            Width = 397
                            Height = 227
                            Name ="Étiquette3"
                            Caption ="&CC :"
                            FontName ="Arial"
                        End
                    End
                End
                Begin TextBox
                    OverlapFlags = 87
                    AccessKey = 73
                    Left = 510
                    Top = 1133
                    Width = 7490
                    Height = 283
                    TabIndex = 3
                    ForeColor = 128
                    Name ="txtBCC"
                    Format ="@;[Blue]\"Destinataires en copie cachée\""
                    FontName ="Arial"
                    ControlTipText ="Liste des destinataires en copie cachée, séparés par des point-virgules."
                    Begin
                        Begin Label
                            OverlapFlags = 93
                            Left = 113
                            Top = 1133
                            Width = 397
                            Height = 227
                            Name ="Étiquette5"
                            Caption ="CC&I :"
                            FontName ="Arial"
                        End
                    End
                End
                Begin TextBox
                    OverlapFlags = 87
                    AccessKey = 79
                    Left = 737
                    Top = 1473
                    Width = 7263
                    Height = 284
                    TabIndex = 4
                    ForeColor = 128
                    Name ="txtObjet"
                    Format ="@;[Blue]\"Objet du message\""
                    FontName ="Arial"
                    OnKeyDown ="[Event Procedure]"
                    ControlTipText ="Objet du message"
                    Begin
                        Begin Label
                            OverlapFlags = 93
                            Left = 113
                            Top = 1473
                            Width = 624
                            Height = 227
                            Name ="Étiquette7"
                            Caption ="&Objet :"
                            FontName ="Arial"
                        End
                    End
                End
                Begin TextBox
                    OverlapFlags = 215
                    AccessKey = 68
                    Left = 510
                    Top = 113
                    Width = 7490
                    Height = 283
                    ForeColor = 128
                    Name ="txtDe"
                    Format ="@;[Blue]\"Adresse de messagerie de l'expéditeur\""
                    ValidationRule ="Like \"*?@?*.?*\""
                    ValidationText ="Adresse de messagerie invalide."
                    FontName ="Arial"
                    ControlTipText ="Expéditeur du message."
                    Begin
                        Begin Label
                            OverlapFlags = 93
                            Left = 113
                            Top = 113
                            Width = 453
                            Height = 226
                            Name ="Étiquette85"
                            Caption ="&De :"
                            FontName ="Arial"
                        End
                    End
                End
            End
        End
        Begin Section
            Height = 2676
            BackColor = -2147483633
            Name ="Détail"
            Begin
                Begin Tab
                    OverlapFlags = 93
                    Left = 105
                    Width = 7395
                    Height = 2676
                    Name ="CtlTab112"
                    Begin
                        Begin Page
                            OverlapFlags = 215
                            Left = 240
                            Top = 420
                            Width = 7125
                            Height = 2115
                            Name ="pgText"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00dadadadadadadadaadadadadadadadaddadadadadadadada ,
                                0xa4444dad444444adda74dadad7447adaada44dada744adaddad74adad447dada ,
                                0xadad4444444dadaddada74da447adadaadada44d44adadaddadad74447dadada ,
                                0xadadad444dadadaddadada747adadadaadadada4adadadaddadadadadadadada ,
                                0xadadadadadadadad
                            End
                            Caption ="Texte brut"
                            Begin
                                Begin TextBox
                                    EnterKeyBehavior = NotDefault
                                    ScrollBars = 2
                                    OverlapFlags = 215
                                    AccessKey = 77
                                    TextAlign = 1
                                    Left = 277
                                    Top = 478
                                    Width = 6828
                                    Height = 2040
                                    ForeColor = 128
                                    Name ="txtMessage"
                                    Format ="@;[Blue]\"Tapez votre message ici.\""
                                    FontName ="Arial"
                                    OnKeyDown ="[Event Procedure]"
                                End
                            End
                        End
                        Begin Page
                            OverlapFlags = 247
                            Left = 240
                            Top = 420
                            Width = 7125
                            Height = 2115
                            Name ="pgHTML"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00999999999999999999999999999999999999999999999999 ,
                                0x9999999999999999dadadadadadadada4444ada444444dadd74adada7447dada ,
                                0xad44adad744dadadda74dada447adadaada4444444adadaddad74ad447dadada ,
                                0xadad44a44dadadaddada74447adadadaadada444adadadaddadad747dadadada ,
                                0xadadad4dadadadad
                            End
                            Caption ="HTML"
                            Begin
                                Begin TextBox
                                    EnterKeyBehavior = NotDefault
                                    ScrollBars = 2
                                    OverlapFlags = 247
                                    AccessKey = 77
                                    TextAlign = 1
                                    Left = 273
                                    Top = 480
                                    Width = 4267
                                    Height = 2040
                                    ForeColor = 128
                                    Name ="txtMsgHTML"
                                    Format ="@;[Blue]\"Placez votre code HTML ici.\""
                                    FontName ="Arial"
                                    OnKeyDown ="[Event Procedure]"
                                End
                                Begin CommandButton
                                    OverlapFlags = 247
                                    Left = 4596
                                    Top = 480
                                    Width = 958
                                    Height = 313
                                    TabIndex = 1
                                    Name ="cmdHTML"
                                    Caption ="<HTML>..."
                                    OnClick ="[Event Procedure]"
                                    FontName ="Arial"
                                    ControlTipText ="Charger un fichier HTML."
                                End
                            End
                        End
                    End
                End
                Begin TextBox
                    Visible = NotDefault
                    SpecialEffect = 0
                    OldBorderStyle = 1
                    OverlapFlags = 215
                    Left = 6852
                    Width = 1134
                    Height = 227
                    TabIndex = 1
                    BackColor = 0
                    ForeColor = 65535
                    Name ="txtIdentifiant"
                End
            End
        End
        Begin FormFooter
            Height = 4308
            BackColor = -2147483633
            Name ="PiedFormulaire"
            Begin
                Begin CommandButton
                    OverlapFlags = 85
                    Left = 283
                    Top = 3401
                    Width = 1984
                    Height = 340
                    Name ="cmdEnregistrer"
                    Caption ="Enregistrer"
                    OnClick ="[Event Procedure]"
                    FontName ="Arial"
                End
                Begin CommandButton
                    OverlapFlags = 85
                    Left = 5669
                    Top = 3401
                    Width = 1984
                    Height = 340
                    TabIndex = 4
                    Name ="cmdAnnuler"
                    Caption ="Fermer"
                    OnClick ="[Event Procedure]"
                    FontName ="Arial"
                End
                Begin CheckBox
                    OverlapFlags = 85
                    Left = 453
                    Top = 3771
                    Width = 171
                    Height = 170
                    TabIndex = 1
                    Name ="chkEnvImmed"
                    AfterUpdate ="[Event Procedure]"
                    DefaultValue ="False"
                    Begin
                        Begin Label
                            OverlapFlags = 85
                            Left = 683
                            Top = 3741
                            Width = 3180
                            Height = 240
                            Name ="Étiquette75"
                            Caption ="et envoyer immédiatement le message."
                            FontName ="Arial"
                        End
                    End
                End
                Begin CheckBox
                    OverlapFlags = 85
                    Left = 453
                    Top = 4028
                    Width = 171
                    Height = 170
                    TabIndex = 2
                    Name ="chkOuvert"
                    DefaultValue ="False"
                    Begin
                        Begin Label
                            OverlapFlags = 85
                            Left = 683
                            Top = 3998
                            Width = 3180
                            Height = 240
                            Name ="Étiquette77"
                            Caption ="Garder cette fenêtre ouverte."
                            FontName ="Arial"
                        End
                    End
                End
                Begin CommandButton
                    OverlapFlags = 85
                    Left = 3004
                    Top = 3401
                    Width = 1984
                    Height = 340
                    TabIndex = 3
                    Name ="cmdRAZ"
                    Caption ="RAZ"
                    OnClick ="[Event Procedure]"
                    FontName ="Arial"
                    ControlTipText ="Efface tous les champs"
                End
                Begin Tab
                    OverlapFlags = 85
                    Left = 120
                    Top = 30
                    Width = 7935
                    Height = 3330
                    TabIndex = 5
                    Name ="CtlTab10"
                    FontName ="Arial"
                    Begin
                        Begin Page
                            OverlapFlags = 215
                            AccessKey = 70
                            Left = 249
                            Top = 450
                            Width = 7672
                            Height = 2775
                            Name ="pgPJ"
                            ControlTipText ="Liste des fichiers à joindre"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00dadadadadadadada00000000000dadad08888888880adada ,
                                0x0088888800000000080888880ff88880088088800b700780080f000f0f08f080 ,
                                0x00f8f8f80b08b0800f8f8f8f0f08f080a0f8f8f80b08b080da0f8f8f0f08f080 ,
                                0xada0f8f00b08bfb0dada000a00077000adadadadad08f0addadadadada700ada ,
                                0xadadadadadadadad
                            End
                            Caption ="&Fichiers joints"
                            Begin
                                Begin ListBox
                                    ColumnHeads = NotDefault
                                    RowSourceTypeInt = 0
                                    OverlapFlags = 247
                                    MultiSelect = 2
                                    ColumnCount = 3
                                    Left = 249
                                    Top = 477
                                    Width = 6351
                                    Height = 2327
                                    Name ="lstPJ"
                                    ColumnWidths ="1701;852;5670"
                                    FontName ="Arial"
                                End
                                Begin CommandButton
                                    OverlapFlags = 215
                                    AccessKey = 74
                                    Left = 6716
                                    Top = 664
                                    Width = 1201
                                    Height = 340
                                    TabIndex = 1
                                    Name ="cmdAjouter"
                                    Caption ="A&jout fichier..."
                                    OnClick ="[Event Procedure]"
                                    FontName ="Arial"
                                    ControlTipText ="Ajouter un fichier."
                                End
                                Begin CommandButton
                                    Visible = NotDefault
                                    OverlapFlags = 215
                                    AccessKey = 66
                                    Left = 6720
                                    Top = 1080
                                    Width = 1201
                                    Height = 340
                                    TabIndex = 2
                                    Name ="cmdPJOA"
                                    Caption ="Ajout o&bjet..."
                                    FontName ="Arial"
                                    ControlTipText ="Ajouter un objet Access."
                                End
                                Begin CommandButton
                                    OverlapFlags = 215
                                    AccessKey = 82
                                    Left = 6720
                                    Top = 1650
                                    Width = 1201
                                    Height = 340
                                    TabIndex = 3
                                    Name ="cmdRetirer"
                                    Caption ="&Retirer"
                                    OnClick ="[Event Procedure]"
                                    FontName ="Arial"
                                    ControlTipText ="Retirer une pièce jointe."
                                End
                                Begin TextBox
                                    Enabled = NotDefault
                                    Locked = NotDefault
                                    OverlapFlags = 215
                                    BackStyle = 0
                                    Left = 1650
                                    Top = 2858
                                    Width = 4950
                                    Height = 227
                                    TabIndex = 4
                                    ForeColor = 128
                                    Name ="Texte25"
                                    ControlSource ="=[lstPJ].[ListCount]-1 & \" élément(s) pour une taille totale de \" & Format$(Li"
                                        "stePJ_Taille(),\"#,##0\") & \" octet(s).\""
                                    Format ="#,##0\" Ko\""
                                    FontName ="Arial"
                                    Begin
                                        Begin Label
                                            OverlapFlags = 223
                                            Left = 354
                                            Top = 2858
                                            Width = 1299
                                            Height = 227
                                            Name ="Étiquette26"
                                            Caption ="Pièces jointes :"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                            End
                        End
                        Begin Page
                            OverlapFlags = 247
                            AccessKey = 82
                            Left = 255
                            Top = 450
                            Width = 7665
                            Height = 2775
                            Name ="pgDSN"
                            ControlTipText ="Avis de remise SMTP (DSN)"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00dadadadadadadada00000000000dadad08888888880adada ,
                                0x00888800000000000808880bfffbfff00880880ffbfffbf0080f000bf0fb00f0 ,
                                0x00f8f80f0b0ffbf00f8f8f0bfff0fff0a0f8f80ffbfffbf0da0f8f0bf0fb00f0 ,
                                0xada0f80f0b0ffbf0dada000bfff0fff0adadad0ffbfffbf0dadada0000000000 ,
                                0xadadadadadadadad
                            End
                            Caption ="&Remise"
                            Begin
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 255
                                    Left = 340
                                    Top = 510
                                    Width = 3345
                                    Height = 227
                                    FontWeight = 700
                                    Name ="Étiquette27"
                                    Caption ="Avis de remise (DSN)"
                                    FontName ="Arial"
                                End
                                Begin CheckBox
                                    OverlapFlags = 255
                                    AccessKey = 83
                                    Left = 872
                                    Top = 1306
                                    Width = 284
                                    Height = 227
                                    OptionValue = 1
                                    Name ="chkNOT_1"
                                    AfterUpdate ="=chkNOT_X()"
                                    DefaultValue ="False"
                                    ControlTipText ="Notifier en cas de remise correcte."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 1099
                                            Top = 1249
                                            Width = 737
                                            Height = 227
                                            Name ="Étiquette34"
                                            Caption ="&Succès"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin CheckBox
                                    OverlapFlags = 255
                                    AccessKey = 69
                                    Left = 1836
                                    Top = 1306
                                    Width = 283
                                    Height = 227
                                    TabIndex = 1
                                    OptionValue = 2
                                    Name ="chkNOT_2"
                                    AfterUpdate ="=chkNOT_X()"
                                    DefaultValue ="False"
                                    ControlTipText ="Notifier en cas d'échec de la remise."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 2063
                                            Top = 1249
                                            Width = 623
                                            Height = 227
                                            Name ="Étiquette36"
                                            Caption ="&Echec"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin CheckBox
                                    OverlapFlags = 255
                                    AccessKey = 68
                                    Left = 2686
                                    Top = 1306
                                    Width = 284
                                    Height = 227
                                    TabIndex = 2
                                    OptionValue = 4
                                    Name ="chkNOT_4"
                                    AfterUpdate ="=chkNOT_X()"
                                    DefaultValue ="False"
                                    ControlTipText ="Notifier si la remise est différée."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 247
                                            Left = 2913
                                            Top = 1249
                                            Width = 624
                                            Height = 227
                                            Name ="Étiquette38"
                                            Caption ="&Différé"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    FontItalic = NotDefault
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 589
                                    Top = 739
                                    Width = 3094
                                    Height = 227
                                    Name ="Étiquette39"
                                    Caption ="Notification"
                                    FontName ="Arial"
                                End
                                Begin Label
                                    FontItalic = NotDefault
                                    SpecialEffect = 5
                                    OverlapFlags = 255
                                    Left = 589
                                    Top = 1533
                                    Width = 3118
                                    Height = 227
                                    Name ="Étiquette40"
                                    Caption ="Retourner"
                                    FontName ="Arial"
                                End
                                Begin OptionGroup
                                    SpecialEffect = 0
                                    OldBorderStyle = 0
                                    OverlapFlags = 247
                                    Left = 589
                                    Top = 1760
                                    Width = 3515
                                    Height = 963
                                    TabIndex = 3
                                    Name ="cdrRET"
                                    AfterUpdate ="[Event Procedure]"
                                    DefaultValue ="0"
                                    Begin
                                        Begin OptionButton
                                            OverlapFlags = 255
                                            AccessKey = 86
                                            Left = 872
                                            Top = 1873
                                            Width = 284
                                            Height = 227
                                            OptionValue = 0
                                            Name ="Option70"
                                            ControlTipText ="Utilise les valeurs par défaut du serveur SMTP distant."
                                            Begin
                                                Begin Label
                                                    OverlapFlags = 247
                                                    Left = 1099
                                                    Top = 1816
                                                    Width = 3005
                                                    Height = 227
                                                    Name ="Étiquette71"
                                                    Caption ="&Val. par défaut du serveur distant"
                                                    FontName ="Arial"
                                                End
                                            End
                                        End
                                        Begin OptionButton
                                            OverlapFlags = 255
                                            AccessKey = 78
                                            Left = 872
                                            Top = 2156
                                            Width = 284
                                            Height = 227
                                            OptionValue = 1
                                            Name ="Option44"
                                            ControlTipText ="Retourne seulement les en-têtes de message."
                                            Begin
                                                Begin Label
                                                    OverlapFlags = 247
                                                    Left = 1099
                                                    Top = 2100
                                                    Width = 3005
                                                    Height = 226
                                                    Name ="Étiquette45"
                                                    Caption ="E&n-têtes seuls"
                                                    FontName ="Arial"
                                                End
                                            End
                                        End
                                        Begin OptionButton
                                            OverlapFlags = 247
                                            AccessKey = 71
                                            Left = 872
                                            Top = 2440
                                            Width = 284
                                            Height = 227
                                            OptionValue = 2
                                            Name ="Option46"
                                            ControlTipText ="Retourne le message complet avec l'accusé de réception."
                                            Begin
                                                Begin Label
                                                    OverlapFlags = 247
                                                    Left = 1099
                                                    Top = 2383
                                                    Width = 3005
                                                    Height = 227
                                                    Name ="Étiquette47"
                                                    Caption ="Messa&ge complet"
                                                    FontName ="Arial"
                                                End
                                            End
                                        End
                                    End
                                End
                                Begin Label
                                    FontItalic = NotDefault
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 4330
                                    Top = 739
                                    Width = 3119
                                    Height = 227
                                    Name ="Étiquette48"
                                    Caption ="ID Enveloppe"
                                    FontName ="Arial"
                                End
                                Begin CheckBox
                                    Enabled = NotDefault
                                    OverlapFlags = 247
                                    Left = 4614
                                    Top = 1079
                                    Width = 170
                                    Height = 170
                                    TabIndex = 4
                                    Name ="chkEnvID"
                                    AfterUpdate ="[Event Procedure]"
                                    DefaultValue ="False"
                                    ControlTipText ="Ajouter un identifiant au message."
                                End
                                Begin TextBox
                                    Enabled = NotDefault
                                    OverlapFlags = 247
                                    Left = 4841
                                    Top = 1023
                                    Width = 2608
                                    Height = 283
                                    TabIndex = 5
                                    Name ="txtEnvID"
                                    AfterUpdate ="[Event Procedure]"
                                    OnKeyUp ="[Event Procedure]"
                                    OnKeyPress ="[Event Procedure]"
                                    ControlTipText ="Identifiant de message (94 car. max)"
                                End
                                Begin CheckBox
                                    OverlapFlags = 247
                                    AccessKey = 74
                                    Left = 872
                                    Top = 1079
                                    Width = 284
                                    Height = 227
                                    TabIndex = 6
                                    OptionValue = 0
                                    Name ="chkNOT_128"
                                    AfterUpdate ="[Event Procedure]"
                                    DefaultValue ="False"
                                    ControlTipText ="Ne jamais envoyer de notification."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 247
                                            Left = 1099
                                            Top = 1023
                                            Width = 680
                                            Height = 226
                                            Name ="Étiquette32"
                                            Caption ="&Jamais"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    OverlapFlags = 247
                                    TextAlign = 3
                                    Left = 7483
                                    Top = 1020
                                    Width = 397
                                    Height = 283
                                    Name ="lblNbCar"
                                End
                            End
                        End
                        Begin Page
                            OverlapFlags = 247
                            Left = 255
                            Top = 450
                            Width = 7665
                            Height = 2775
                            Name ="pgOptions"
                            ControlTipText ="Avis de réception et de lecture"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00dadadadadadadadaadadadadadadadaddadadada4fdadada ,
                                0xadadada444fdadaddadada4444fadada00000444f44fadad0fff444f0a44fada ,
                                0x0f7774ff0da4fdad0fffffff0ada4fda0f77777f0dada4fd0fffffff0adada4f ,
                                0x0f77888f0dadada40ffff0000adadada0f778080adadadad0ffff00adadadada ,
                                0x000000adadadadad
                            End
                            Caption ="O&ptions"
                            Begin
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 566
                                    Top = 793
                                    Width = 2830
                                    Height = 284
                                    Name ="txtRRT"
                                    ValidationRule ="Like \"*@*.*\" Or Is Null"
                                    ValidationText ="Adresse de messagerie invalide."
                                    FontName ="Arial"
                                    ControlTipText ="Return-Receipt-To"
                                End
                                Begin CommandButton
                                    OverlapFlags = 247
                                    Left = 3401
                                    Top = 793
                                    Width = 302
                                    Height = 302
                                    TabIndex = 1
                                    Name ="cmdExp01"
                                    Caption ="Commande108"
                                    OnClick ="=CopieExped([txtRRT])"
                                    PictureData = Begin
                                        0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                        0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                        0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                        0xffff0000ffffff00dadadadadadadadaadadadadada1adaddadadadada117ada ,
                                        0x0dadad0da1111dad0ad000da111a11daa00da0ada1ada11dda0a000adadada11 ,
                                        0xa00dada0adadada10000dad0dadadada000dadad0dadadad000ada00dadadada ,
                                        0x00000da0adadadad0000000a0adadadaa00000000dadadadda00000adadadada ,
                                        0xadadadadadadadad
                                    End
                                    ObjectPalette = Begin
                                        0x0003100000000000800000000080000080800000000080008000800000808000 ,
                                        0x80808000c0c0c000ff000000c0c0c000ffff00000000ff00c0c0c00000ffff00 ,
                                        0xffffff0000000000
                                    End
                                    ControlTipText ="Identique au champ 'De'"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 566
                                    Top = 1474
                                    Width = 2830
                                    Height = 284
                                    TabIndex = 2
                                    Name ="txtDNT"
                                    ValidationRule ="Like \"*@*.*\" Or Is Null"
                                    ValidationText ="Adresse de messagerie invalide."
                                    FontName ="Arial"
                                    ControlTipText ="Disposition-Notification-To"
                                End
                                Begin CommandButton
                                    OverlapFlags = 247
                                    Left = 3401
                                    Top = 1474
                                    Width = 302
                                    Height = 302
                                    TabIndex = 3
                                    Name ="cmdExp02"
                                    Caption ="Commande108"
                                    OnClick ="=CopieExped([txtDNT])"
                                    PictureData = Begin
                                        0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                        0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                        0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                        0xffff0000ffffff00dadadadadadadadaadadadadada1adaddadadadada117ada ,
                                        0x0dadad0da1111dad0ad000da111a11daa00da0ada1ada11dda0a000adadada11 ,
                                        0xa00dada0adadada10000dad0dadadada000dadad0dadadad000ada00dadadada ,
                                        0x00000da0adadadad0000000a0adadadaa00000000dadadadda00000adadadada ,
                                        0xadadadadadadadad
                                    End
                                    ObjectPalette = Begin
                                        0x0003100000000000800000000080000080800000000080008000800000808000 ,
                                        0x80808000c0c0c000ff000000c0c0c000ffff00000000ff00c0c0c00000ffff00 ,
                                        0xffffff0000000000
                                    End
                                    ControlTipText ="Identique au champ 'De'"
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 340
                                    Top = 1190
                                    Width = 3345
                                    Height = 240
                                    FontWeight = 700
                                    Name ="Étiquette102"
                                    Caption ="Avis de lecture (MDN)"
                                    FontName ="Arial"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 566
                                    Top = 2154
                                    Width = 2830
                                    Height = 284
                                    TabIndex = 4
                                    Name ="txtReplyTo"
                                    ValidationRule ="Like \"*@*.*\" Or Is Null"
                                    ValidationText ="Adresse de messagerie invalide."
                                    FontName ="Arial"
                                    ControlTipText ="Adresse(s) pour la réponse."
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 340
                                    Top = 510
                                    Width = 3345
                                    Height = 225
                                    FontWeight = 700
                                    Name ="Étiquette104"
                                    Caption ="Accusé de réception"
                                    FontName ="Arial"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 566
                                    Top = 2778
                                    Width = 2830
                                    Height = 284
                                    TabIndex = 5
                                    Name ="txtSender"
                                    ValidationRule ="Like \"*@*.*\" Or Is Null"
                                    ValidationText ="Adresse de messagerie invalide."
                                    FontName ="Arial"
                                    ControlTipText ="Adresse de l'envoyeur du message\015\012(doit être différente de 'De')."
                                End
                                Begin ComboBox
                                    RowSourceTypeInt = 1
                                    OverlapFlags = 247
                                    AccessKey = 82
                                    TextAlign = 2
                                    ColumnCount = 2
                                    ListWidth = 2880
                                    Left = 4444
                                    Top = 796
                                    Width = 1871
                                    Height = 284
                                    FontWeight = 700
                                    TabIndex = 6
                                    Name ="lstPriorite"
                                    RowSourceType ="Value List"
                                    RowSource ="5;\"Faible\";3;\"Normale\";1;\"Haute\""
                                    ColumnWidths ="0"
                                    DefaultValue ="3"
                                    FontName ="Arial"
                                    Begin
                                        Begin Label
                                            SpecialEffect = 5
                                            OverlapFlags = 247
                                            Left = 4195
                                            Top = 510
                                            Width = 3345
                                            Height = 240
                                            FontWeight = 700
                                            Name ="P&riorité_Étiquette"
                                            Caption ="P&riorité"
                                            FontName ="Arial"
                                            EventProcPrefix ="P_riorité_Étiquette"
                                        End
                                    End
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    TextAlign = 2
                                    Left = 4478
                                    Top = 1473
                                    Width = 2779
                                    Height = 280
                                    TabIndex = 7
                                    Name ="txtDifferer"
                                    Format ="dddd dd/mm/yyyy hh:nn:ss;;[Blue]\"Non différé\";[Blue]\"Non différé\""
                                    DefaultValue ="0"
                                    FontName ="Arial"
                                    ControlTipText ="Le message ne sera pas envoyé\015\012avant cette date/heure."
                                    Begin
                                        Begin Label
                                            SpecialEffect = 5
                                            OverlapFlags = 247
                                            Left = 4195
                                            Top = 1190
                                            Width = 3396
                                            Height = 228
                                            FontWeight = 700
                                            Name ="Étiquette128"
                                            Caption ="Envoyer le message après :"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 340
                                    Top = 1870
                                    Width = 3345
                                    Height = 240
                                    FontWeight = 700
                                    Name ="Étiquette140"
                                    Caption ="Répondre à (Reply-To)"
                                    FontName ="Arial"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    TextAlign = 2
                                    Left = 4478
                                    Top = 2154
                                    Width = 2779
                                    Height = 280
                                    TabIndex = 8
                                    Name ="txtConserver"
                                    Format ="dddd dd/mm/yyyy hh:nn:ss;;[Blue]\"Pas de conservation\";[Blue]\"Pas de conservat"
                                        "ion\""
                                    DefaultValue ="0"
                                    FontName ="Arial"
                                    ControlTipText ="Purge n'effacera pas le message\015\012avant cette date/heure."
                                    Begin
                                        Begin Label
                                            SpecialEffect = 5
                                            OverlapFlags = 247
                                            Left = 4195
                                            Top = 1870
                                            Width = 3396
                                            Height = 228
                                            FontWeight = 700
                                            Name ="Étiquette130"
                                            Caption ="Conserver le message jusqu'au :"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 340
                                    Top = 2494
                                    Width = 3345
                                    Height = 240
                                    FontWeight = 700
                                    Name ="Étiquette142"
                                    Caption ="Envoyeur (Sender)"
                                    FontName ="Arial"
                                End
                            End
                        End
                        Begin Page
                            Enabled = NotDefault
                            OverlapFlags = 247
                            Left = 255
                            Top = 450
                            Width = 7665
                            Height = 2775
                            Name ="pgOptSrv"
                            ControlTipText ="Options du serveur SMTP"
                            PictureData = Begin
                                0x2800000010000000100000000100040000000000800000000000000000000000 ,
                                0x0000000000000000000000000000800000800000008080008000000080008000 ,
                                0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                                0xffff0000ffffff00dadadadadadadadaadada00000adadaddad00ee27e00dada ,
                                0xad0eee2727ee0dadd0eeee7272eee0daa0eeee27272ee0ad0eeeee72727eee0a ,
                                0x0ee727272727ee0d0ee272727272e20a0ee727272727270d0ee2727e72e2720a ,
                                0xa0ee27eeeee720add0e27272727270daad0ee72727270daddad00e727200dada ,
                                0xadada00000adadad
                            End
                            Caption ="&Serveur"
                            Begin
                                Begin Label
                                    OverlapFlags = 247
                                    Left = 524
                                    Top = 2405
                                    Width = 7200
                                    Height = 672
                                    ForeColor = 128
                                    Name ="Étiquette56"
                                    Caption ="Note :\015\012Ces options ne sont utilisées que lors d'un envoi immédiat. Elles "
                                        "sont ignorées si le message est enregistré pour être envoyé plus tard."
                                    FontName ="Arial"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 1020
                                    Top = 793
                                    Width = 2098
                                    Height = 284
                                    Name ="txtNomSRV"
                                    FontName ="Arial"
                                    ControlTipText ="Nom du serveur SMTP distant"
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 510
                                            Top = 793
                                            Width = 510
                                            Height = 227
                                            Name ="Étiquette80"
                                            Caption ="Nom"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    TextAlign = 2
                                    Left = 3174
                                    Top = 793
                                    Width = 511
                                    Height = 284
                                    TabIndex = 1
                                    Name ="txtPort"
                                    DefaultValue ="25"
                                    FontName ="Arial"
                                    ControlTipText ="Port de connexion"
                                End
                                Begin TextBox
                                    OverlapFlags = 247
                                    Left = 1814
                                    Top = 1133
                                    Width = 1871
                                    Height = 284
                                    TabIndex = 2
                                    Name ="txtHELODomain"
                                    FontName ="Arial"
                                    ControlTipText ="Nom de domaine de l'émetteur"
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 510
                                            Top = 1133
                                            Width = 1304
                                            Height = 227
                                            Name ="Étiquette82"
                                            Caption ="HELODomain"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 247
                                    Left = 340
                                    Top = 510
                                    Width = 3345
                                    Height = 227
                                    FontWeight = 700
                                    Name ="Étiquette78"
                                    Caption ="Serveur"
                                    FontName ="Arial"
                                End
                                Begin TextBox
                                    Enabled = NotDefault
                                    OverlapFlags = 247
                                    Left = 5499
                                    Top = 1303
                                    Width = 2041
                                    Height = 227
                                    TabIndex = 4
                                    Name ="txtAUTH_ID"
                                    FontName ="Arial"
                                    ControlTipText ="Nom d'utilisateur ou identifiant de connexion."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 4648
                                            Top = 1303
                                            Width = 850
                                            Height = 227
                                            Name ="Étiquette67"
                                            Caption ="Identifiant"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin TextBox
                                    Enabled = NotDefault
                                    OverlapFlags = 247
                                    Left = 5499
                                    Top = 1587
                                    Width = 2041
                                    Height = 227
                                    TabIndex = 5
                                    Name ="txtAUTH_MDP"
                                    FontName ="Arial"
                                    InputMask ="Password"
                                    ControlTipText ="Mot de passe associé à l'identifiant."
                                    Begin
                                        Begin Label
                                            OverlapFlags = 255
                                            Left = 4648
                                            Top = 1587
                                            Width = 850
                                            Height = 227
                                            Name ="Étiquette69"
                                            Caption ="Mot Passe"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                                Begin Label
                                    SpecialEffect = 5
                                    OverlapFlags = 255
                                    Left = 4195
                                    Top = 510
                                    Width = 3333
                                    Height = 227
                                    FontWeight = 700
                                    Name ="Étiquette54"
                                    Caption ="Authentification"
                                    FontName ="Arial"
                                End
                                Begin ComboBox
                                    RowSourceTypeInt = 1
                                    OverlapFlags = 247
                                    TextAlign = 2
                                    ColumnCount = 2
                                    Left = 4422
                                    Top = 1020
                                    Width = 3118
                                    Height = 227
                                    TabIndex = 6
                                    Name ="lstAUTH"
                                    RowSourceType ="Value List"
                                    ColumnWidths ="0"
                                    AfterUpdate ="[Event Procedure]"
                                    DefaultValue ="0"
                                    FontName ="Arial"
                                    Begin
                                        Begin Label
                                            FontItalic = NotDefault
                                            SpecialEffect = 5
                                            OverlapFlags = 247
                                            Left = 4422
                                            Top = 737
                                            Width = 3118
                                            Height = 226
                                            Name ="Étiquette135"
                                            Caption ="Méthode"
                                            FontName ="Arial"
                                        End
                                    End
                                End
                            End
                        End
                    End
                End
            End
        End
    End
End
CodeBehindForm
Option Compare Database
Option Explicit

' Copyright 2009-2013 Denis SCHEIDT
' Ce programme est distribué sous Licence LGPL

'    This file is part of libMAIL

'    libMAIL is free software: you can redistribute it and/or modify
'    it under the terms of the GNU Lesser General Public License as published by
'    the Free Software Foundation, either version 3 of the License, or
'    (at your option) any later version.

'    libMAIL is distributed in the hope that it will be useful,
'    but WITHOUT ANY WARRANTY; without even the implied warranty of
'    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'    GNU Lesser General Public License for more details.

'    You should have received a copy of the GNU Lesser General Public License
'    along with this program.  If not, see <http://www.gnu.org/licenses/>.


' Tableau pour les pièces jointes fichiers
Private Type tuListePJ
    NomPJ           As String                                       ' Nom de la pièce jointe
    NomFichier      As String                                       ' Nom du fichier
    Chemin          As String                                       ' Chemin d'accès au fichier, terminé par \
    Taille          As Long                                         ' Taille du fichier (octets).
    PJOA            As String                                       ' Spécification de PJ objet Access.
    Temp            As Boolean                                      ' Fichier temporaire, à supprimer à la fermeture du formulaire.
End Type
Dim dtuListePJ()    As tuListePJ                                    ' Tableau pour la liste des pièces jointes
Dim IMGTmp()        As String                                       ' Tableau des images du corps HTML (modif. de message)


Private Const Caption_NM    As String = "Edition d'un nouveau message."
Private Const caption_MM    As String = "Modification du message n°"


' Transmission des paramètres depuis ECreeMail()
' Il n'est pas possible de passer directement un Type utilisateur à un formulaire
' (ou à un module de classe) sous Access 97.
' Il faut contourner à l'aide de CopyMemory
' La propriété prend simplement le pointeur sur la TU à copier, donné par VarPtr()
Property Let MAIL(ptrMAIL As Long)
    Dim dtuMail As tuMAIL, b() As Byte, lNbOctets As Integer
#If Vba7 Then
        Dim ptrDTULoc As LongPtr
#Else
        Dim ptrDTULoc As Long
#End If

    ptrDTULoc = VarPtr(dtuMail)                                     ' Pointeur sur la DTU locale.
    lNbOctets = LenB(dtuMail)                                       ' Taille de la DTU.
    ReDim b(lNbOctets)                                              ' Initialiser le tableau pour la sauvegarde.
    CopyMemory ByVal VarPtr(b(0)), ByVal ptrDTULoc, lNbOctets       ' Sauvegarde de la DTU locale.
    CopyMemory ByVal ptrDTULoc, ByVal ptrMAIL, lNbOctets            ' Copier la DTU externe sur la locale.

    '  On peut maintenant récupérer les valeurs
    Call DtuAChamps(dtuMail)

    ' Il faut restaurer la DTU temporaire telle qu'elle était avant la manipulation, afin que la libération de mémoire se fasse
    ' proprement. Ceci est essentiel si la DTU contient des chaînes de longueur variable, ou des tableaux.
    ' Dans ces deux cas, la DTU ne contient qu'un pointeur vers les données réelles.
    ' Si on ne restaure pas la DTU originale, les chaînes et tableaux seront libérés à la fin de la Property.
    ' La procédure appelante tentera également de libérer cette même zone de mémoire ---> GPF ---> crash Access.
    CopyMemory ByVal ptrDTULoc, ByVal VarPtr(b(0)), lNbOctets

    Me.Caption = Caption_NM                                         ' Titre de la fenêtre
End Property

' Transmission de l'ID du message à modifier, utilisé par ModifieMail.
' Charge le message demandé à partir de la table.
Property Let IDMail(sID As String)
    Dim db As DAO.Database, rs As DAO.Recordset, dtuMail As tuMAIL, dtuCM() As tuCorpsMIME
    Dim i As Integer, j0 As Integer, j1 As Integer, n As Integer, s As String, PJTmp() As String
    Dim sC As String, sN As String, sE As String

    Call RaZModif                                              ' Nettoyage préalable...
    Call RaZForm

    Set db = CurrentDb

    ' Changer l'état du message afin qu'il ne soit pas sélectionné si un envoi démarre
    db.Execute "UPDATE " & TableMail() & " SET Etat='M' WHERE Etat='E' AND Identifiant='" & sID & "'"
    If db.RecordsAffected = 0 Then
        MsgBox "Le message demandé n'existe pas, ou il n'est pas en boite d'envoi.", vbCritical, "Modifier le message " & sID

        db.Close
        Set db = Nothing
        Exit Property
    End If

    ' Sélectionner le message à modifier.
    Set rs = db.OpenRecordset("SELECT * FROM " & TableMail() & " WHERE Etat='M' And Identifiant='" & sID & "'", dbOpenDynaset)
    rs.MoveFirst

    DoCmd.Hourglass True

    ' Analyse le corps du message et sépare les différentes parties.
    ReDim dtuCM(0)
    Call MIMEAnalyse(rs!CorpsMsg, dtuCM())

    ' Préparer le tableau des pièces jointes.
    ReDim PJTmp(1, 100)
    ' Ainsi que celui des images du corps HTML.
    ReDim IMGTmp(1, 100)

    For i = 0 To UBound(dtuCM)
        ' Extraire au passage les parties TEXT et HTML du message.
        If Len(dtuCM(i).ContentDisposition) = 0 Then
            If dtuCM(i).ContentType = "text/plain" Then dtuMail.Message.Texte = DecPartie(dtuCM(i))
            If dtuCM(i).ContentType = "text/html" Then dtuMail.Message.HTML = DecPartie(dtuCM(i))
        End If

        ' --Pièces jointes. ----------------------------------------------------------------------------
        If Len(dtuCM(i).FileName) <> 0 Then
            n = FreeFile()

            If Len(dtuCM(i).ContentID) = 0 Then                 ' --Fichier joint. ---------------------
                PJTmp(0, j0) = DecObjet(dtuCM(i).Name)          ' Nom du fichier.
                PJTmp(1, j0) = FichTemp("PJ_")                  ' Sauvegarder dans un fichier temporaire.
                Open PJTmp(1, j0) For Output As n

                j0 = j0 + 1

            Else                                                ' --Image de corps HTML. ---------------
                IMGTmp(0, j1) = DecObjet(dtuCM(i).Name)         ' Nom du fichier.
                IMGTmp(1, j1) = FichTemp("IMG_")                ' Sauvegarder dans un fichier temporaire.
                Call AnaSpecFich(IMGTmp(1, j1), sC, sN, sE)     ' Décomposer le nom.
                Name IMGTmp(1, j1) As sC & IMGTmp(0, j1)        ' Renommer le fichier temporaire...
                IMGTmp(1, j1) = sC & IMGTmp(0, j1)              ' pour ne pas perdre le nom d'origine.
                Open IMGTmp(1, j1) For Output As n

                ' Remplacer le cid:... de la balise <IMG> par le chemin du fichier temporaire.
                s = dtuCM(i).ContentID
                s = "cid:" & Mid$(s, 2, Len(s) - 2)             ' Ajouter "cid:" et retirer '<' et '>'
                dtuMail.Message.HTML = Remplacer(dtuMail.Message.HTML, s, IMGTmp(1, j1), , , vbTextCompare)

                j1 = j1 + 1

            End If

            Print #n, DecPartie(dtuCM(i));                      ' Décoder et écrire la PJ dans le fichier.
            Close #n
        End If
    Next i

    If j0 = 0 Then
        ReDim PJTmp(1, 0)                                       ' Aucune PJ dans le message
    Else
        ReDim Preserve PJTmp(1, j0 - 1)                         ' Ajuster le tableau
    End If

    DoCmd.Hourglass False


    With dtuMail
        .Identifiant = sID
        .De = Nz(rs!Expediteur)
        .a = Nz(rs!Destinataires)
        .cc = Nz(rs!cc)
        .BCC = Nz(rs!BCC)
        .Objet = DecObjet(Nz(rs!Objet))
        .OptionsMSG = DTU_MSG_Dec(rs!ESMTP)
        .Utilisateur = Nz(rs!Utilisateur)
        If j0 > 0 Then .PJ = PJTmp
        .Differer = Nz(rs!Differer, 0)
        .Conserver = Nz(rs!Conserver, 0)
    End With
    Erase dtuCM

    Call DtuAChamps(dtuMail)                                    ' Renseigner les champs du formulaire.

    ' En modification de message, il n'y a pour l'instant QUE des fichiers temporaires.
    ' On passe donc tous les .Temp à Vrai
    For i = 0 To UBound(dtuListePJ)
        dtuListePJ(i).Temp = True
    Next i

    rs.Close
    Set rs = Nothing

    Erase PJTmp()

    Me.Caption = caption_MM & sID                               ' Titre de la fenêtre
End Property
'
' ====================================================================================================================



' Renseigne les champs du formulaire à partir des membres de la dtu.
' Applique les formatages sur les champs.
Private Sub DtuAChamps(dtuMail As tuMAIL)
    Dim i As Integer

    ' Renseigner les champs du formulaire
    With dtuMail
        Me.txtIdentifiant = .Identifiant                        ' Sauvegarde de l'identifiant
        Me.txtDe = .De
        Me.txtA = .a
        Me.txtCC = .cc
        Me.txtBCC = .BCC
        Me.txtObjet = .Objet
        Me.txtMessage = .Message.Texte
        Me.txtMsgHTML = .Message.HTML
        ' Options de Notification
        With dtuMail.OptionsMSG.DSN
            Me.chkNOT_1 = (.Notification And lmlESMTPDsnNotifSucces)
            Me.chkNOT_2 = (.Notification And lmlESMTPDsnNotifEchec)
            Me.chkNOT_4 = (.Notification And lmlESMTPDsnNotifDelai)
            Me.chkNOT_128 = (.Notification And lmlESMTPDsnNotifJamais)
        End With
        Call MarqueChk

        ' Liste des pièces jointes, s'il y en a...
        ReDim dtuListePJ(0)                                     ' Vider le tableau
        If Not IsEmpty(.PJ) Then
            For i = 0 To UBound(.PJ, 2)
                Call AjouteCible((.PJ(1, i)), (.PJ(0, i)))
            Next i
        End If
        'Me.lstPJ.Requery                                        ' Actualiser la liste
        ' Sous Access 2010, cette instruction ne suffit pas à afficher le contenu de la liste lorsqu'on
        ' modifie un message. La liste reste vide, bien qu'elle contienne une ou plusieurs lignes.
        Me.Recalc

        ' Options de Retour
        Me.cdrRET = .OptionsMSG.DSN.Retour
        Call MarqueOption(Me.cdrRET)

        ' ID Enveloppe
        Me.txtEnvID = Left$(.OptionsMSG.DSN.IDEnveloppe, 94)
        Me.chkEnvID = (Nz(Me.txtEnvID, "") <> "")
        Me.chkEnvID.Enabled = (Me.cdrRET <> lmlESMTPDsnRetDefaut)
        Me.txtEnvID.Enabled = (Me.cdrRET <> lmlESMTPDsnRetDefaut And Me.chkEnvID)

        ' Avis de réception et de lecture
        Me.txtRRT = .OptionsMSG.MDN.Reception
        Me.txtDNT = .OptionsMSG.MDN.Notification

        ' Champs origine du message
        Me.txtReplyTo = .OptionsMSG.ORG.Repondre
        Me.txtSender = .OptionsMSG.ORG.Envoyeur

        ' Autres options
        Me.txtDifferer = .Differer
        Me.txtConserver = .Conserver
    End With
End Sub

' Marque les options de Notification
Private Sub MarqueChk()
    Call MarqueCtl(Me.Étiquette32, Me.chkNOT_128)
    Call MarqueCtl(Me.Étiquette34, Me.chkNOT_1)
    Call MarqueCtl(Me.Étiquette36, Me.chkNOT_2)
    Call MarqueCtl(Me.Étiquette38, Me.chkNOT_4)
End Sub

' Change la couleur et la graisse de l'étiquette.
Private Sub MarqueCtl(ctl As Control, bMarque As Boolean)
    ctl.FontBold = bMarque
    ctl.ForeColor = IIf(bMarque, 128, 0)
End Sub

' Met en gras l'option choisie dans un groupe d'options.
Private Sub MarqueOption(cdr As OptionGroup)
    Dim ctl As Control

    For Each ctl In cdr.Controls
        If TypeOf ctl Is Label And TypeOf ctl.Parent Is OptionButton Then
            Call MarqueCtl(ctl, ctl.Parent.OptionValue = cdr.Value)
        End If
    Next ctl
End Sub

' Clic dans les cases à cocher de notification.
Private Function chkNOT_X()
    If (Me.chkNOT_1 Or Me.chkNOT_2 Or Me.chkNOT_4) Then Me.chkNOT_128 = False
    Call MarqueChk
End Function

' Eclate une spécification de fichier pour l'ajouter à la liste des PJ.
' La ligne n'est pas ajoutée si le fichier n'existe pas.

' Les PJOA sont transformées en fichier temporaires pour deux raisons :
'   - c'est la seule manière de connaître la taille réelle de la PJ ;
'   - si on transmet une PJOA à SauveMail (bouton Enregistrer), il y aura une nouvelle génération, ce qui peut
'     être gênant si le traitement est très long.
Private Sub AjouteCible(sChemFich As String, Optional sNomPJ As String = "")
    Dim sChemFichTmp As String, sNom As String, sChem As String, i As Integer, bTmp As Boolean

    sChemFichTmp = sChemFich
    If sChemFichTmp Like "#/*/*/*" Then                     ' Traitement d'une PJOA.
        i = PJOA_GenFichier(sChemFichTmp)                   ' Crée un fichier temporaire pour l'objet Access.

        If Len(sNomPJ) = 0 Then                             ' Si pas de nom spécifié pour la PJ,
            i = InStrFin(sChemFich, "/")
            sNomPJ = Mid$(sChemFich, i + 1)                 ' Récupérer le nom de l'objet comme nom de PJ.
        End If

        bTmp = True                                         ' On ajoute un fichier temporaire.

    End If

    If Not FichierExiste(sChemFichTmp) Then Exit Sub

    sNom = Dir$(sChemFichTmp)                               ' Ne garder que le nom de fichier.
    i = InStr(sChemFichTmp, sNom)
    sChem = Left$(sChemFichTmp, i - 1)                      ' Extraire le chemin.
    If Len(sNomPJ) = 0 Then sNomPJ = sNom                   ' S'il n'y avait pas de nom pour la PJ, utiliser le nom de fichier...

    If Not sChemFich Like "#/*/*/*" Then
        Call AjouteElt(sChem, sNom, sNomPJ, bTmp)           ' Ajouter à la liste (fichier normal).
    Else
        Call AjouteElt(sChem, sNom, sNomPJ, bTmp, sChemFich) ' Ajouter à la liste (PJOA).
    End If
End Sub

' Ajoute un élément à la zone de liste
' sChemin contient le chemin seul.
' sFichier contient le nom de fichier seul.
' sNomPJ est le nom attribué à la PJ. Peut être différent du nom de fichier.
' bTemp indique si le fichier est un fichier temporaire qui sera supprimé à la fermeture du formulaire.
Private Sub AjouteElt(sChemin As String, sFichier As String, sNomPJ As String, bTemp As Boolean, Optional sPJOA As String = "")
    Dim i As Long, sChemin1 As String

    ' S'assurer que le chemin termine bien par \
    sChemin1 = sChemin & IIf(Right$(sChemin, 1) = "\", "", "\")

    ' Vérifier si l'élément existe déjà.
    i = UBound(dtuListePJ)
    Do
        With dtuListePJ(i)
            Select Case Len(sPJOA)
                Case 0
                    If .Chemin = sChemin1 And .NomFichier = sFichier Then Exit Do
                Case Else
                    If .PJOA = sPJOA Then Exit Do
            End Select
        End With
        i = i - 1
    Loop While i >= 0

    If i >= 0 Then Exit Sub                                 ' Le fichier existe déja dans la liste.

    i = UBound(dtuListePJ)
    If Len(dtuListePJ(i).Chemin) <> 0 Then i = i + 1
    ReDim Preserve dtuListePJ(i)                            ' Agrandir le tableau.
    With dtuListePJ(i)
        .NomPJ = sNomPJ
        .NomFichier = sFichier
        .Chemin = sChemin1
        .Taille = FileLen(sChemin1 & sFichier)              ' Taille du fichier.
        .PJOA = sPJOA                                       ' Spécification originelle si PJOA.
        .Temp = bTemp
    End With
End Sub

' Fonction de liste PJ Fichiers
Private Function ListePJ(chp As Control, iD As Variant, lgn As Variant, col As Variant, code As Variant) As Variant
    Dim vRet As Variant

    Select Case code
        Case acLBInitialize                                 ' Initialise.
            vRet = (dtuListePJ(0).NomFichier <> "")

        Case acLBOpen                                       ' Ouvre.
            vRet = Timer                                    ' Génère un ID unique.

        Case acLBGetRowCount                                ' Lit le nombre de lignes.
            vRet = UBound(dtuListePJ) + 1 - (dtuListePJ(0).NomFichier <> "")

        Case acLBGetColumnCount                             ' Lit le nombre de colonnes.
            vRet = 3

        Case acLBGetColumnWidth                             ' Largeur de colonne.
            vRet = -1                                       ' Utilise la largeur par défaut.

        Case acLBGetValue                                   ' Saisit les données.
            If lgn = 0 Then                                 ' En-têtes de colonnes
                Select Case col
                    Case 0: vRet = "P.J."
                    Case 1: vRet = "Taille"
                    Case 2: vRet = "Chemin"
                End Select
            Else
                Select Case col
                    Case 0: vRet = dtuListePJ(lgn - 1).NomPJ
                    Case 1: vRet = dtuListePJ(lgn - 1).Taille
                    Case 2: If Len(dtuListePJ(lgn - 1).PJOA) = 0 Then vRet = dtuListePJ(lgn - 1).Chemin Else vRet = dtuListePJ(lgn - 1).PJOA
                End Select
            End If

        Case acLBEnd                                        ' Fermeture de la liste
            ' Le tableau n'étant pas initialisé par la fonction, on ne fait rien ici.

    End Select
    ListePJ = vRet
End Function

' Retourne la taille totale des pièces jointes.
Private Function ListePJ_Taille() As Long
    Dim i As Long

    For i = 0 To UBound(dtuListePJ)
        ListePJ_Taille = ListePJ_Taille + dtuListePJ(i).Taille
    Next i
End Function

' Contrôle la présence des infos nécessaire au démarrage immédiat du serveur
' Retour : 0 : Saisie incomplète. Ne pas enregistrer, ni envoyer.
'          1 : Il manque une info, enregistrer le message sans l'envoyer.
'          2 : Tout est OK pour l'envoi.
Private Function VerifEnvoiImmed() As Integer
    Dim s As String, i As Integer

    ' Champs serveur
    If Len(Nz(Me.txtNomSRV, "")) = 0 Then s = "   Nom du serveur" & vbCrLf
    If Len(Nz(Me.txtHELODomain, "")) = 0 Then s = s & "    HELODomain" & vbCrLf

    ' Champs Authentification
    If Me.lstAUTH <> lmlESMTPAuthAucune Then
        If Len(Nz(Me.txtAUTH_ID, "")) = 0 Then s = s & "    Identifiant" & vbCrLf
        If Len(Nz(Me.txtAUTH_MDP, "")) = 0 Then s = s & "    Mot de passe" & vbCrLf
    End If

    If Len(s) = 0 Then
        VerifEnvoiImmed = 2
        Exit Function
    End If

    s = "Le message ne peut pas être envoyé immédiatement car les champs ci-dessous ne sont pas renseignés :" & vbCrLf & _
        s & vbCrLf & _
        "- Cliquez sur 'OK' pour enregistrer le message et l'envoyer plus tard ;" & vbCrLf & _
        "- Cliquez sur 'Annuler' pour revenir à l'édition du message et compléter les informations manquantes."
    
    i = MsgBox(s, vbInformation + vbOKCancel + vbDefaultButton2, "Envoi immédiat impossible")

    Select Case i
        Case vbOK:  VerifEnvoiImmed = 1
        Case vbCancel: VerifEnvoiImmed = 0
    End Select
End Function

Private Function CopieExped(txtBox As TextBox)
    txtBox = Me.txtDe
End Function

' RàZ des données du formulaire
Private Sub RaZForm()
    Dim dtuRaZ As tuMAIL

    Me.txtDe.Tag = Nz(Me.txtDe)                             ' Ne pas perdre l'expéditeur.
    Call DtuAChamps(dtuRaZ)                                 ' Remise à zéro des champs du formulaire, à l'aide d'une DTU vide.
    Me.txtDe = Me.txtDe.Tag                                 ' Restaurer l'expéditeur.

    Me.Caption = Caption_NM                                 ' Titre de la fenêtre.
End Sub

' Rétablit l'état des messages et supprime les fichiers temporaires.
Private Sub RaZModif()
    Dim i As Integer, s As String

    ' Rétablir le message de 'M' vers 'E'. Sera sans effet si le message a déjà été enregistré.
    CurrentDb.Execute "UPDATE " & TableMail() & " SET Etat='E' WHERE Etat='M' AND Identifiant='" & Me.txtIdentifiant & "'"

    ' Supprimer les fichiers temporaires.
    For i = 0 To UBound(dtuListePJ)
        s = dtuListePJ(i).Chemin & dtuListePJ(i).NomFichier
        If dtuListePJ(i).Temp Then
            If FichierExiste(s) Then
                Kill s
                Call Journal(Me.Name & " : Le fichier temporaire " & s & " a été effacé.")
            Else
                Call Journal(Me.Name & " : Le fichier temporaire " & s & " n'a pas été effacé car il n'existait pas.")
            End If
        End If
    Next i
    ReDim dtuListePJ(0)                                 ' Effacer le tableau des PJ.

    ' Supprimer les fichiers temporaires pour les images incorporées.
    For i = 0 To UBound(IMGTmp, 2)
        If FichierExiste(IMGTmp(1, i)) Then
            Kill IMGTmp(1, i)
        End If
    Next i
    ReDim IMGTmp(1, 0)                                  ' Effacer le tableau des images.

    Me.txtIdentifiant = ""                              ' Effacer l'identifiant.
End Sub
'
' ====================================================================================================================



Private Sub cmdHTML_Click()
    Dim dtuOFN As OPENFILENAME, sFiltre As String, l As Long

    sFiltre = "Fichiers HTML" & vbNullChar & "*.html;*.htm" & vbNullChar & _
              "Tous les fichiers" & vbNullChar & "*.*"

    With dtuOFN
        .lStructSize = Len(dtuOFN)
        .hWndOwner = Me.hwnd
        .sFilter = sFiltre
        .lFilterIndex = 1
        .sFile = vbNullChar & Space$(32764)
        .lMaxFile = Len(.sFile)
        .sFileTitle = vbNullChar & Space$(512)
        .lMaxFileTitle = Len(.sFileTitle)
'        .sInitialDir = "c:\temp" & vbNullChar & Space$(512) & vbNullChar & vbNullChar
        .sDialogTitle = "Fichier HTML à insérer..."
        .lFlags = OFN_ENABLESIZING Or OFN_FILEMUSTEXIST Or OFN_PATHMUSTEXIST Or OFN_EXPLORER
        .sDefFileExt = "*.html"
    End With

    l = GetOpenFileName(dtuOFN)

    If l = 0 Then Exit Sub                              ' Annulé par l'utilisateur.

    If FileLen(dtuOFN.sFile) > 64000 Then
        If MsgBox("Ce fichier fait plus de 64000 octets. Il sera tronqué à cette longueur." & vbCrLf & "Voulez-vous l'importer tout de même ?", _
                  vbQuestion + vbYesNo, dtuOFN.sFile) = vbNo Then Exit Sub
    End If

    ' Insère les 64000 premiers caractères dans la zone de texte,
    ' sinon--> Texte trop long pour pouvoir être modifié.
    DoCmd.Hourglass True
    Me.txtMsgHTML = HTMLCharge(dtuOFN.sFile)
    DoCmd.Hourglass False

    If Len(Me.txtMessage) > 0 Then
        If MsgBox("libMAIL peut convertir le message HTML en texte brut et le placer dans l'onglet 'Texte'." & vbCrLf & _
                  "Voulez-vous remplacer le message texte brut existant ?", vbQuestion + vbYesNo) = vbNo Then Exit Sub
    End If

    ' Convertir HTML en texte brut.
    DoCmd.Hourglass True
    Me.txtMessage = HTMLaTexte(Me.txtMsgHTML)
    DoCmd.Hourglass False
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Call RaZModif                                           ' On fait le ménage avant de fermer.
End Sub

Private Sub lstAUTH_AfterUpdate()
    If IsNull(Me.lstAUTH) Then Me.lstAUTH = 0

    Me.txtAUTH_ID.Enabled = (Me.lstAUTH > 0)
    Me.txtAUTH_MDP.Enabled = (Me.lstAUTH > 0)

    If Me.txtAUTH_ID.Enabled Then Me.txtAUTH_ID.SetFocus
End Sub

Private Sub cdrRET_AfterUpdate()
    Call MarqueOption(Me.cdrRET)

    Me.chkEnvID.Enabled = (Me.cdrRET <> lmlESMTPDsnRetDefaut)
    Me.txtEnvID.Enabled = (Me.cdrRET <> lmlESMTPDsnRetDefaut And Me.chkEnvID)
End Sub

Private Sub chkEnvID_AfterUpdate()
    Me.txtEnvID.Enabled = Me.chkEnvID
    If Me.chkEnvID Then Me.txtEnvID.SetFocus
End Sub

Private Sub chkEnvImmed_AfterUpdate()
    Me.pgOptSrv.Enabled = Me.chkEnvImmed
End Sub

Private Sub chkNOT_128_AfterUpdate()
    Me.chkNOT_1 = False
    Me.chkNOT_2 = False
    Me.chkNOT_4 = False
    Call MarqueChk
End Sub

Private Sub cmdAjouter_Click()
    Dim dtuOFN As OPENFILENAME, sFiltre As String, vFichiers As Variant
    Dim i As Integer, l As Long, sSpecF As String

    sFiltre = "Fichiers images" & vbNullChar & "*.jpg;*.jpeg;*.tig;*.bmp;*.gif" & vbNullChar & _
              "Documents Office" & vbNullChar & "*.do*;*.xl*;*.pp*;*.md*" & vbNullChar & _
              "Documents PDF" & vbNullChar & "*.pdf" & vbNullChar & _
              "Tous les fichiers" & vbNullChar & "*.*"

    With dtuOFN
        .lStructSize = Len(dtuOFN)
        .hWndOwner = Me.hwnd
        .sFilter = sFiltre
        .lFilterIndex = 4
        .sFile = vbNullChar & Space$(32764)
        .lMaxFile = Len(.sFile)
        .sFileTitle = vbNullChar & Space$(512)
        .lMaxFileTitle = Len(.sFileTitle)
'        .sInitialDir = "c:\temp" & vbNullChar & Space$(512) & vbNullChar & vbNullChar
        .sDialogTitle = "Fichier(s) à joindre au message..."
        .lFlags = OFN_ALLOWMULTISELECT Or OFN_ENABLESIZING Or OFN_FILEMUSTEXIST Or OFN_PATHMUSTEXIST Or OFN_EXPLORER
        .sDefFileExt = "*.*"
    End With

    l = GetOpenFileName(dtuOFN)
    If l = 0 Then Exit Sub
'    l = CommDlgExtendedError()

    ' Sélection d'un seul fichier : C:\Temp\PJ1.txt
    ' Sélection de plusieurs fichiers dans le même dossier : C:\Temp<00>PJ1.txt<00>PJ2.txt
    ' Sélection contenant un raccourci (en dernière position) :
    '       C:\Temp<00>PJ2.txt<00>PJ1.txt<00>C:\Dossier\SMTP_SRV.LOG
    vFichiers = Scinder(Trim$(dtuOFN.sFile), vbNullChar)

    If UBound(vFichiers) = 1 Then                           ' Un seul fichier sélectionné.
        Call AjouteCible((vFichiers(0)))                    ' Ajouter le fichier.

    Else                                                    ' Sélection multiple.
        For i = 1 To UBound(vFichiers) - 1                  ' La ligne 0 contient le chemin.
            If InStr(vFichiers(i), "\") = 0 Then            ' Si c'est un chemin + fichier.
                Call AjouteCible(vFichiers(0) & "\" & vFichiers(i))
            Else                                            ' Raccourci dans une sélection multiple.
                Call AjouteCible((vFichiers(i)))
            End If
        Next i

    End If
 
    Me.lstPJ.Requery
End Sub

Private Sub cmdAnnuler_Click()
    DoCmd.Close acForm, Me.Name, acSaveNo
End Sub

Private Sub cmdEnregistrer_Click()
    Dim i As Integer, s As String, iRep As Integer, dtuMail As tuMAIL, dtuOptionsESMTP As tuESMTP, dtuServeur As tuServeur

    ' L'expéditeur est obligatoire !
    If Len(Nz(Me.txtDe, "")) = 0 Then
        MsgBox "Vous devez renseigner l'adresse de l'expéditeur avant de pouvoir enregistrer le message :" & vbCrLf & s, , _
                Application.GetOption("Project Name")
        Exit Sub
    End If

    ' Avertissement si aucun destinataire.
    If Len(Nz(Me.txtA, "")) = 0 And Len(Nz(Me.txtCC, "")) = 0 And Len(Nz(Me.txtBCC, "")) = 0 Then
        s = "Ce message ne pourra pas être acheminé correctement car vous n'avez saisi aucun destinataire." & vbCrLf & _
            "Voulez-vous tout de même enregistrer le message ?"
        If MsgBox(s, vbQuestion + vbDefaultButton2 + vbOKCancel, Application.GetOption("Project Name")) = vbCancel Then Exit Sub
    End If

    ' Avertissement si Objet vide.
    If Len(Nz(Me.txtObjet, "")) = 0 Then
        s = "L'objet du message n'a pas été renseigné." & vbCrLf & _
            "Voulez-vous tout de même enregistrer le message ?"
        If MsgBox(s, vbQuestion + vbDefaultButton2 + vbOKCancel, Application.GetOption("Project Name")) = vbCancel Then Exit Sub
    End If

    ' Avertissement si CCi seulement.
    If Len(Nz(Me.txtA, "")) = 0 And Len(Nz(Me.txtCC, "")) = 0 And Len(Nz(Me.txtBCC, "")) <> 0 Then
        s = "Certains systèmes de messagerie électronique peuvent ajouter un champ «Apparently-To» aux messages qui ont uniquement " & _
            "des destinataires CCi. Ce champ, s'il est ajouté, listera tous les destinataires de votre message." & vbCrLf & _
            "Vous devriez saisir au moins un destinataire À ou CC pour éviter cela." & vbCrLf & _
            "Voulez-vous tout de même enregistrer le message ?"
        If MsgBox(s, vbQuestion + vbDefaultButton2 + vbOKCancel, Application.GetOption("Project Name")) = vbCancel Then Exit Sub
    End If

    ' Contrôle de l'envoyeur
    ' - Envoyeur ne doit contenir qu'une seule adresse mail.
    If Me.txtSender Like "*?@?*.?*" & DELIM & "*" Then
        MsgBox "L'adresse de l'envoyeur ne peut contenir qu'une seule adresse !", vbCritical
        Me.txtSender.SetFocus
        Exit Sub
    End If
    ' - Si 1 seul 'De' et 'De' = 'Envoyeur', ignorer Envoyeur.
    If InStr(Me.txtDe, DELIM) = 0 And Me.txtDe = Me.txtSender Then
        Me.txtSender = Null
        MsgBox "L'expéditeur et l'envoyeur sont identiques. L'adresse de l'envoyeur a été supprimée.", vbInformation
    End If


    iRep = 1                                                ' Sauvegarder seulement, par défaut.
    If Me.chkEnvImmed Then                                  ' Si la case est cochée,
        iRep = 2                                            ' il faut aussi envoyer.
        If dtuEtatSyst.EtatSrv.Etat = lmlSrvDecharge Then
            ' Le serveur étant déchargé, on a besoin des informations fournies dans l'onglet serveur, si elles sont complètes.
            iRep = VerifEnvoiImmed()                        ' Contrôler les infos de serveur pour l'envoi.
            If iRep = 0 Then Exit Sub                       ' Incomplet : l'utilisateur a annulé sa demande.
        End If
    End If

    DoCmd.Hourglass True

    ' Maintenant, de toute manière, on enregistre le message.
    ' Remplir la DTU avec les champs du formulaire
    With dtuMail
        .Identifiant = Nz(Me.txtIdentifiant, "")
        .De = Nz(Me.txtDe)
        .a = Nz(Me.txtA)
        .cc = Nz(Me.txtCC)
        .BCC = Nz(Me.txtBCC)
        .Objet = Nz(Me.txtObjet)
        .Message.Texte = Nz(Me.txtMessage)
        .Message.HTML = Nz(Me.txtMsgHTML)
        ' Options de Notification
        .OptionsMSG.DSN.Notification = Abs(Me.chkNOT_1 * lmlESMTPDsnNotifSucces + _
                                           Me.chkNOT_2 * lmlESMTPDsnNotifEchec + _
                                           Me.chkNOT_4 * lmlESMTPDsnNotifDelai + _
                                           Me.chkNOT_128 * lmlESMTPDsnNotifJamais)

        .OptionsMSG.DSN.Retour = Me.cdrRET                  ' Options de Retour

        ReDim .PJ(1, UBound(dtuListePJ))                    ' Liste des pièces jointes, s'il y en a...
        For i = 0 To UBound(dtuListePJ)
            If Len(dtuListePJ(i).NomFichier) <> 0 Then
                .PJ(0, i) = dtuListePJ(i).NomPJ
                .PJ(1, i) = dtuListePJ(i).Chemin & dtuListePJ(i).NomFichier
            End If
        Next i

        ' ID Enveloppe
        .OptionsMSG.DSN.IDEnveloppe = IIf(Me.chkEnvID, (Nz(Me.txtEnvID, "")), "")

        ' Avis de réception et de lecture
        .OptionsMSG.MDN.Reception = Nz(Me.txtRRT)
        .OptionsMSG.MDN.Notification = Nz(Me.txtDNT)

        ' Champs origine du message
        .OptionsMSG.ORG.Envoyeur = Nz(Me.txtSender)
        .OptionsMSG.ORG.Repondre = Nz(Me.txtReplyTo)

        ' Priorité du message
        .OptionsMSG.Priorite = Nz(Me.lstPriorite)

        ' Autres options
        .Differer = Nz(Me.txtDifferer, 0)
        .Conserver = Nz(Me.txtConserver, 0)
    End With

    s = dtuMail.Identifiant                                 ' Identifiant avant sauvegarde.
    Call SauveMail(dtuMail)                                 ' Sauvegarde du message.

    DoCmd.Hourglass False

    If s = dtuMail.Identifiant Then
        MsgBox "Les modifications du message '" & s & "' ont été enregistrées.", vbInformation
    Else
        MsgBox "Le message a été créé avec l'identifiant '" & dtuMail.Identifiant & "'", vbInformation
    End If


    If iRep >= 2 Then                                       ' Il faut envoyer le message.
        dtuServeur = dtuEtatSyst.Serveur                    ' Sauvegarder les options Serveur

        ' Selon l'état du serveur à ce moment
        Select Case dtuEtatSyst.EtatSrv.Etat
            Case lmlSrvDecharge                             ' Le serveur est déchargé.
                ' On envoie à l'aide des informations fournies et on quitte le serveur.
                With dtuOptionsESMTP
                    .AUTH.Methode = Me.lstAUTH
                    .AUTH.Utilisateur = Nz(Me.txtAUTH_ID)
                    .AUTH.MotDePasse = Nz(Me.txtAUTH_MDP)
                End With
                Call ESMTPLance(Me.txtNomSRV & ":" & Me.txtPort, dtuOptionsESMTP, Me.txtHELODomain)
                Call SMTPEnvoieMaintenant                   ' Accélérer le mouvement :)

                ' Attendre le début de l'envoi ou le déchargement du serveur.
                ' (après le début de l'envoi, on peut restaurer les options Serveur précédentes)
                Do Until dtuEtatSyst.EtatSrv.Etat = lmlSrvEnCours Or _
                         dtuEtatSyst.EtatSrv.Etat = lmlSrvDecharge
                    DoEvents
                Loop
                dtuEtatSyst.Serveur = dtuServeur            ' Restaurer les options Serveur

            Case lmlSrvAttente                              ' Le serveur est en attente.
                ' Appliquer les options de serveur pour cet envoi.
                With dtuEtatSyst.Serveur
                    .NomSrv = Me.txtNomSRV
                    .PortSrv = Me.txtPort
                    .HELOdomain = Me.txtHELODomain
                    .OptionsESMTP = dtuOptionsESMTP
                End With
                ' Relance le serveur pour l'envoi immédiat.
                Call SMTPEnvoieMaintenant                   ' Forcer l'envoi immédiat

                ' Attendre le début de l'envoi ou le retour en Attente.
                ' (après le début de l'envoi, on peut restaurer les options Serveur précédentes)
                Do Until dtuEtatSyst.EtatSrv.Etat = lmlSrvEnCours Or _
                         dtuEtatSyst.EtatSrv.Etat = lmlSrvAttente
                    DoEvents
                Loop
                dtuEtatSyst.Serveur = dtuServeur            ' Restaurer les options Serveur

            Case Else
                ' Le serveur est suspendu, ou déjà en train d'envoyer.
                ' Pas possible d'envoyer maintenant.
                MsgBox "L'état actuel du serveur SMTP ne permet pas d'envoyer immédiatement le message." & vbCrLf & _
                       "Le message a été enregistré dans la table " & TableMail() & " et sera envoyé lors de la prochaine scrutation.", _
                       vbInformation

        End Select

    End If

    Call RaZModif                                           ' Faire le ménage sur le disque et dans la table.

    ' Garder le formulaire ouvert ?
    If Me.chkOuvert Then
        Call RaZForm
    Else
        DoCmd.Close acForm, Me.Name, acSaveNo
    End If
End Sub

Private Sub cmdRAZ_Click()
    If MsgBox("Voulez-vous effacer tous les champs du formulaire ?" & vbCrLf & _
              "(Toutes les modifications non enregistrées seront perdues !)", vbYesNo + vbQuestion + vbDefaultButton2) = vbYes Then
        Call RaZModif
        Call RaZForm
    End If
End Sub

Private Sub cmdRetirer_Click()
    Dim i As Long, j As Long                                ' i=elt examiné, j=destination pour copie

    If Me.lstPJ.ItemsSelected.Count = 0 Then Exit Sub

    ' Effacer du tableau les éléments marqués dans la liste
    For i = 1 To Me.lstPJ.ListCount - 1
        If Me.lstPJ.Selected(i) Then
            dtuListePJ(i - 1).Taille = -1
            Me.lstPJ.Selected(i) = False                    ' Eliminer toutes les sélections
        End If
    Next i

    ' Compacter le tableau
    For i = 0 To UBound(dtuListePJ)
        If dtuListePJ(i).Taille >= 0 Then                   ' Elément non sélectionné
            If i > j Then dtuListePJ(j) = dtuListePJ(i)     ' Copier i sur j (si différents)
            j = j + 1                                       ' Destination suivante
        End If
    Next i

    ' Réduire le tableau
    If j <= 0 Then
        ReDim dtuListePJ(0)
    Else
        ReDim Preserve dtuListePJ(j - 1)
    End If

    Me.lstPJ.Requery                                        ' Rafraîchir la liste
End Sub

Private Sub Form_Load()
    Call MarqueChk
    Call MarqueOption(Me.cdrRET)

    ReDim dtuListePJ(0)                                     ' Liste des PJ fichiers
    ReDim IMGTmp(1, 0)

    Me.lstPJ.RowSourceType = "ListePJ"

    ' Initialisation de l'onglet Serveur à partir de la variable d'état
    Me.lstAUTH.RowSource = lmlESMTPAuthAucune & ";Aucune;" & _
                           lmlESMTPAuthLogin & ";LOGIN (mot de passe transmis en clair);" & _
                           lmlESMTPAuthPlain & ";PLAIN (mot de passe transmis en clair);" & _
                           lmlESMTPAuthCRAMMD5 & ";CRAM-MD5;" & _
                           lmlESMTPAuthDIGESTMD5 & ";DIGEST-MD5;" & _
                           lmlESMTPAuthSTARTTLS & ";STARTTLS"

    With dtuEtatSyst.Serveur
        Me.txtNomSRV = .NomSrv
        If .PortSrv <> 0 Then Me.txtPort = .PortSrv
        Me.txtHELODomain = IIf(Len(.HELOdomain) = 0, myComputerName(), .HELOdomain)
        Me.lstAUTH = .OptionsESMTP.AUTH.Methode
        Me.txtAUTH_ID = .OptionsESMTP.AUTH.Utilisateur
        Me.txtAUTH_MDP = .OptionsESMTP.AUTH.MotDePasse
    End With
End Sub

Private Sub Form_Resize()
    Dim l As Long

    Me.Painting = False
    ' ======================================================
    l = Me.CtlTab10.Left + Me.CtlTab10.Width + 60
    If Me.InsideWidth > l Then
        ' Largeur des zones d'en-tête
        l = Me.InsideWidth - Me.txtDe.Left - 60
        Me.txtDe.Width = l
        Me.txtA.Width = l
        Me.txtCC.Width = l
        Me.txtBCC.Width = l

        Me.txtObjet.Width = Me.InsideWidth - Me.txtObjet.Left - 60

        ' Contenu du contrôle onglets Texte et HTML
        l = Me.InsideWidth - Me.CtlTab112.Left - Me.txtMessage.Left - 60
        Me.txtMessage.Width = l
        Me.txtMsgHTML.Width = l - Me.cmdHTML.Width
        Me.cmdHTML.Left = Me.txtMsgHTML.Left + Me.txtMsgHTML.Width + 30

        ' Largeur du contrôle onglets
        Me.CtlTab112.Width = l                              ' Texte et HTML
    Else
        Me.InsideWidth = l + 60
    End If

    ' ======================================================
    ' Hauteur restant pour le détail
    l = Me.InsideHeight - Me.EntêteFormulaire.Height - Me.PiedFormulaire.Height

    If l > 1400 Then
        ' D'abord ramener les contrôles à 0
        Me.txtMessage.Height = 0
        Me.txtMsgHTML.Height = 0
        Me.CtlTab112.Height = 0

        Me.Détail.Height = l                                ' Retailler le détail

        Me.CtlTab112.Height = l - 30
        Me.txtMessage.Height = Me.pgText.Height - Me.txtMessage.Top + Me.pgText.Top
        Me.txtMsgHTML.Height = Me.pgHTML.Height - Me.txtMsgHTML.Top + Me.pgHTML.Top
    Else
        Me.InsideHeight = Me.EntêteFormulaire.Height + Me.PiedFormulaire.Height + 1400
    End If

    Me.Painting = True
End Sub

Private Sub txtEnvID_AfterUpdate()
    Me.txtEnvID = Left$(Nz(Me.txtEnvID), 94)
    Me.lblNbCar.Caption = Len(Me.txtEnvID.Text)
End Sub

Private Sub txtEnvID_KeyPress(KeyAscii As Integer)
    If ((KeyAscii < 33 Or KeyAscii > 126) Or Len(Me.txtEnvID.Text) > 93) And KeyAscii <> vbKeyBack And KeyAscii <> vbKeyTab Then
        Beep
        KeyAscii = 0
    End If
End Sub

Private Sub txtEnvID_KeyUp(KeyCode As Integer, Shift As Integer)
    Me.lblNbCar.Caption = Len(Me.txtEnvID.Text)
End Sub

Private Sub txtMessage_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyTab Then Me.lstPJ.SetFocus
    If KeyCode = vbKeyTab And (Shift = acShiftMask) Then Me.txtObjet.SetFocus
End Sub

Private Sub txtMsgHTML_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyTab Then Me.lstPJ.SetFocus
    If KeyCode = vbKeyTab And (Shift = acShiftMask) Then Me.txtObjet.SetFocus
End Sub

Private Sub txtObjet_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyTab And Shift = 0 Then Me.txtMessage.SetFocus
End Sub