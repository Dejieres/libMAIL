Version = 17
VersionRequired = 17
Checksum = 1054235707
Begin Form
    RecordSelectors = NotDefault
    AutoCenter = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    DefaultView = 0
    ScrollBars = 0
    PictureAlignment = 2
    DatasheetGridlinesBehavior = 3
    GridY = 10
    Width = 6406
    DatasheetFontHeight = 10
    ItemSuffix = 27
    Left = 615
    Top = 255
    Right = 7365
    Bottom = 2730
    TimerInterval = 900000
    DatasheetGridlinesColor = 12632256
    OnUnload ="[Event Procedure]"
    RecSrcDt = Begin
        0xc72e512d77cfe240
    End
    Caption ="Relai SMTP"
    DatasheetFontName ="Arial"
    PrtMip = Begin
        0x8905000089050000890500008905000000000000201c0000e010000001000000 ,
        0x010000006801000000000000a10700000100000001000000
    End
    PrtDevMode = Begin
        0x687020627573696e65737320696e6b6a65742031313030207365726965730000 ,
        0x010421409c0064070fdf8007010009009a0b3408640001000700feff02000100 ,
        0x0000030000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000001000000 ,
        0x0300000001000000010000000000000000000000000000000000000042836587 ,
        0x0000000000000000000000000000008888080088880800888808000000000000 ,
        0x00000000340800009a0b0000016400000900000000ffffffff00000000000001 ,
        0x00070000000001014578706c6f72657200000000000000000000000000000000 ,
        0x0000000000000000000000000802000000000000000001010001000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000041007200 ,
        0x690061006c000000000000000000000000000000000000000000000000000000 ,
        0x00000000000000000000000000000000000000000000000000000000e0e0e000 ,
        0x480000001c020000000000004283658701ccdaba000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x000000000000000000ccdaba68007000200062007500730069006e0065007300 ,
        0x7300200069006e006b006a006500740020003100310030003000200073006500 ,
        0x7200690065007300000031003000300020007300650072006900650073002c00 ,
        0x4c006f00630061006c004f006e006c0079002c0044007200760043006f006e00 ,
        0x7600650072007400000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000010000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000
    End
    PrtDevNames = Begin
        0x080011003000010077696e73706f6f6c00687020627573696e65737320696e6b ,
        0x6a65742031313030207365726965730049505f3139322e3136382e302e323030 ,
        0x0000000000000000000000000000000000
    End
    OnTimer ="[Event Procedure]"
    OnLoad ="[Event Procedure]"
    Begin
        Begin Label
            BackStyle = 0
        End
        Begin Line
            Width = 1701
        End
        Begin Image
            BackStyle = 0
            OldBorderStyle = 0
            PictureAlignment = 2
            Width = 1701
            Height = 1701
        End
        Begin CommandButton
            Width = 1701
            Height = 283
            FontSize = 8
            FontWeight = 400
            ForeColor = -2147483630
            FontName ="MS Sans Serif"
        End
        Begin TextBox
            SpecialEffect = 2
            OldBorderStyle = 0
            Width = 1701
            LabelX = -1701
        End
        Begin UnboundObjectFrame
            SpecialEffect = 2
            OldBorderStyle = 1
            Width = 4536
            Height = 2835
        End
        Begin Section
            Height = 850
            BackColor = -2147483633
            Name ="Détail"
            OnMouseMove ="[Event Procedure]"
            Begin
                Begin Image
                    OldBorderStyle = 1
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgNeutre"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x00000000000000008000000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0x800000000000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0x800000008000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0xffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Denis\\Bureau\\TEST\\libMAIL\\lmlNeutre.ico"
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 340
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgAttente"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x000000000000ff000000ff000000ff000000ff000000ff000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000ff0000ffff0000ffff008000000000ffff0000ffff000000ff0000000000 ,
                        0x000000000000000000000000000000000000000000000000000000000000ff00 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff000000ff00 ,
                        0x0000000000000000000000000000000000000000000000000000ff0000ffff00 ,
                        0x00ffff0000ffff0000ffff0000ffff0000ffff0000ffff008000000000ffff00 ,
                        0x0000ff0000000000000000000000000000000000000000000000ff0000ffff00 ,
                        0x00ffff0000ffff0000ffff0000ffff0000ffff008000000000ffff0000ffff00 ,
                        0x0000ff00000000000000000000000000000000000000ff0000ffff0000ffff00 ,
                        0x00ffff0000ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff00 ,
                        0x00ffff000000ff000000000080000000800000000000ff008000000080000000 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff0080000000 ,
                        0x800000000000ff008000000080000000ffff00000000ff0000ffff0000ffff00 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff0000ffff00 ,
                        0x00ffff000000ff0080000000ffff000080000000ffff00000000ff0000ffff00 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff0000ffff00 ,
                        0x0000ff000000000080000000ffff0000ffff0000800000000000ff0000ffff00 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff0000ffff00 ,
                        0x0000ff000000000080000000ffff0000ffff0000ffff0000800000000000ff00 ,
                        0x00ffff0000ffff0000ffff008000000000ffff0000ffff0000ffff000000ff00 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0x0000ff0000ffff0000ffff0000ffff0000ffff0000ffff000000ff00ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff00000000ff000000ff000000ff000000ff000000ff00ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Denis\\Bureau\\TEST\\libMAIL\\lmlAttente.ico"
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 680
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgSuspendu"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000800000008000000080000000000000008000000080000000800000008000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000800000000000000080000000ff000000ff0000008000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000800000000000000080000000ff000000ff0000008000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000800000000000000080000000ff000000ff0000008000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000800000000000000080000000ff000000ff0000008000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000800000000000000080000000ff000000ff0000008000 ,
                        0x0000000000000000000000008000000080000000800000008000000000008000 ,
                        0x0000ff000000ff000000800080000000000080000000ff000000ff0000008000 ,
                        0x00000000000000008000000080000000ffff0000ffff0000ffff000000008000 ,
                        0x0000ff000000ff0000008000ffff0000000080000000ff000000ff0000008000 ,
                        0x800000000000000080000000ffff000080000000ffff0000ffff000000008000 ,
                        0x0000ff000000ff0000008000ffff0000000080000000ff000000ff0000008000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff000000008000 ,
                        0x0000ff000000ff0000008000ffff0000000080000000ff000000ff0000008000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff00008000000000008000 ,
                        0x000080000000800000008000ffff000000008000000080000000800000008000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0xffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Denis\\Bureau\\TEST\\libMAIL\\lmlsuspendu.ico"
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 1020
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgEncours"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x0080000000800000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x00ff000000ff0000008000000080000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x00ff000000ff000000ff000000ff000000800000008000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x00ff000000ff000000ff000000ff000000ff000000ff00000080000000800000 ,
                        0x0000000000000000000000000000000000000000000000000000000000800000 ,
                        0x00ff000000ff000000ff000000ff000000ff000000ff000000ff000000ff0000 ,
                        0x0080000000000000000000008000000080000000800000008000000000800000 ,
                        0x00ff000000ff000000ff000000ff000000ff000000ff00000080000000800000 ,
                        0x00000000000000008000000080000000ffff0000ffff0000ffff000000800000 ,
                        0x00ff000000ff000000ff000000ff00000080000000800000ffff000080000000 ,
                        0x800000000000000080000000ffff000080000000ffff0000ffff000000800000 ,
                        0x00ff000000ff00000080000000800000ffff0000ffff000080000000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff000000800000 ,
                        0x0080000000800000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff00008000000000800000 ,
                        0x800000008000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0xffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Denis\\Bureau\\TEST\\libMAIL\\lmlEnCours.ico"
                End
                Begin Label
                    OverlapFlags = 93
                    Top = 4
                    Width = 2436
                    Height = 288
                    FontSize = 10
                    FontWeight = 700
                    Name ="Étiquette0"
                    Caption ="Emetteur SMTP minimal"
                    FontName ="Arial"
                End
                Begin TextBox
                    Enabled = NotDefault
                    Locked = NotDefault
                    TabStop = NotDefault
                    SpecialEffect = 0
                    OverlapFlags = 85
                    BackStyle = 0
                    Left = 3125
                    Width = 1405
                    Height = 224
                    Name ="Texte9"
                    ControlSource ="=VersionPROG()"
                    FontName ="Arial"
                    Begin
                        Begin Label
                            OverlapFlags = 215
                            TextAlign = 3
                            Left = 2321
                            Width = 768
                            Height = 228
                            Name ="Étiquette10"
                            Caption ="Version"
                            FontName ="Arial"
                        End
                    End
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 1360
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgAnnulation"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000008000000080000000800000008000000080000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x000080000000ff000000ff000000ff000000ff000000ff000000800000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000008000 ,
                        0x0000ff000000ff000000ff000000ff000000ff000000ff000000ff0000008000 ,
                        0x000000000000000000000000000000000000000000000000000080000000ff00 ,
                        0xc0c0c000ffffff000000ff000000ff000000ff00ffffff00c0c0c0000000ff00 ,
                        0x000080000000000000000000000000000000000000000000000080000000ff00 ,
                        0xffffff00ffffff00ffffff000000ff00ffffff00ffffff00ffffff000000ff00 ,
                        0x0000800000000000000000000000000000000000000080000000ff000000ff00 ,
                        0x0000ff00ffffff00ffffff00ffffff00ffffff00ffffff000000ff000000ff00 ,
                        0x0000ff0000008000000000008000000080000000000080000000ff000000ff00 ,
                        0x0000ff000000ff00ffffff00ffffff00ffffff000000ff000000ff000000ff00 ,
                        0x0000ff00000080008000000080000000ffff0000000080000000ff000000ff00 ,
                        0x0000ff00ffffff00ffffff00ffffff00ffffff00ffffff000000ff000000ff00 ,
                        0x0000ff000000800080000000ffff000080000000ffff0000000080000000ff00 ,
                        0xffffff00ffffff00ffffff000000ff00ffffff00ffffff00ffffff000000ff00 ,
                        0x000080000000000080000000ffff0000ffff000080000000000080000000ff00 ,
                        0xc0c0c000ffffff000000ff000000ff000000ff00ffffff00c0c0c0000000ff00 ,
                        0x000080000000000080000000ffff0000ffff0000ffff00008000000000008000 ,
                        0x0000ff000000ff000000ff000000ff000000ff000000ff000000ff0000008000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0x000080000000ff000000ff000000ff000000ff000000ff0000008000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff00000000800000008000000080000000800000008000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="\\\\VBOXSVR\\libMAIL\\trunk\\Images\\lmlAnnulation.ico"
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 1700
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgConnexion"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000080000000800000000000 ,
                        0x0000000000000000008080000080800000000000000000000000000000800000 ,
                        0x00800000000000000000000000000000000080000000ff000000ff0000008000 ,
                        0x000000000080800000ffff0000ffff0000808000000000000080000000ff0000 ,
                        0x00ff0000008000000000000000000000000080000000ff000000ff0000008000 ,
                        0x000000000080800000ffff0000ffff0000808000000000000080000000ff0000 ,
                        0x00ff0000008000000000000000000000000080000000ff000000ff0000008000 ,
                        0x000000000080800000ffff0000ffff0000808000000000000080000000ff0000 ,
                        0x00ff0000008000000000000000000000000080000000ff000000ff0000008000 ,
                        0x000000000080800000ffff0000ffff0000808000000000000080000000ff0000 ,
                        0x00ff000000800000000000008000000080000000000080000000800080000000 ,
                        0x8000000080000000008080000080800080000000800000008000000000800000 ,
                        0x00800000000000008000000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0x800000000000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0x800000008000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0xffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Administrateur\\Bureau\\lmlConnexion.ico"
                End
                Begin Image
                    OldBorderStyle = 1
                    Left = 2040
                    Top = 396
                    Width = 340
                    Height = 340
                    Name ="imgExecCmd"
                    PictureData = Begin
                        0x2800000010000000100000000100200000000000000400000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0x0000000000000000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0x8080800080808000000000000000000000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0xc0c0c000ffffff00808080008080800000000000000000000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0xffffff00c0c0c000ffffff00c0c0c00080808000808080000000000000000000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0xc0c0c000ffffff00c0c0c000ffffff00c0c0c000ffffff008080800080808000 ,
                        0x0000000000000000000000000000000000000000000000000000000080808000 ,
                        0xffffff00c0c0c000ffffff00c0c0c000ffffff00c0c0c000ffffff00c0c0c000 ,
                        0x8080800000000000000000008000000080000000800000008000000080808000 ,
                        0xc0c0c000ffffff00c0c0c000ffffff00c0c0c000ffffff008080800080808000 ,
                        0x00000000000000008000000080000000ffff0000ffff0000ffff000080808000 ,
                        0xffffff00c0c0c000ffffff00c0c0c0008080800080808000ffff000080000000 ,
                        0x800000000000000080000000ffff000080000000ffff0000ffff000080808000 ,
                        0xc0c0c000ffffff008080800080808000ffff0000ffff000080000000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff000080808000 ,
                        0x8080800080808000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff00008000000080808000 ,
                        0x800000008000000080000000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff0000ffff000080000000 ,
                        0xffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff0000ffff000080000000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000ffff0000 ,
                        0x800000000000000080000000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff000080000000ffff0000ffff0000 ,
                        0x8000000000000000800000008000000080000000ffff0000ffff0000ffff0000 ,
                        0xffff0000ffff0000ffff0000ffff0000ffff0000ffff00008000000080000000 ,
                        0x8000000000000000000000008000000080000000800000008000000080000000 ,
                        0x8000000080000000800000008000000080000000800000008000000080000000 ,
                        0x0000000000000000
                    End
                    Picture ="C:\\Documents and Settings\\Administrateur\\Bureau\\lmlExecCmd.ico"
                End
            End
        End
    End
End
CodeBehindForm
Option Compare Database
Option Explicit

' Copyright 2009-2014 Denis SCHEIDT
' Ce programme est distribué sous Licence LGPL

'    This file is part of libMAIL

'    libMAIL is free software: you can redistribute it and/or modify
'    it under the terms of the GNU Lesser General Public License as published by
'    the Free Software Foundation, either version 3 of the License, or
'    (at your option) any later version.

'    libMAIL is distributed in the hope that it will be useful,
'    but WITHOUT ANY WARRANTY; without even the implied warranty of
'    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'    GNU Lesser General Public License for more details.

'    You should have received a copy of the GNU Lesser General Public License
'    along with this program.  If not, see <http://www.gnu.org/licenses/>.


' *************************************************************************
' Pour un fonctionnement correct de l'icône de la zone de notifications :
'   - pas d'en-tête/pied de formulaire  (les événements ne remontent pas) ;
'   - pas de sélecteur d'enregistrement (la valeur X de MouseMove est décalée).
' *************************************************************************

' Extensions SMTP supportées par le SERVEUR DISTANT ========================================
Private Type tuAUTH_SRV
    PLAIN               As Boolean
    LOGIN               As Boolean
    CRAMMD5             As Boolean
    DIGESTMD5           As Boolean
    STARTTLS            As Boolean
End Type

Private Type tuESMTP_EXT_SRV                                        ' Extensions reconnues par le serveur distant
    AUTH                As tuAUTH_SRV                               ' Authentification
    SIZE                As Long                                     ' Taille de message
    DSN                 As Boolean                                  ' Accusé de réception
End Type

Dim ESMTP_SRV           As tuESMTP_EXT_SRV                          ' Recueille les options étendues du serveur distant.
Dim ESMTP_SRV_RAZ       As tuESMTP_EXT_SRV                          ' RàZ rapide.
' ==========================================================================================


Dim lSock               As Long                                     ' Socket pour la connexion.

Dim ESMTP_MSG           As tuESMTP_MSG                              ' Options étendues liées au messages.
' ===================================================================


' *****************************************************************************************************
' Méthodes
' Procédure de traduction de l'interface.
Public Sub ChangeLang()
    ' Actualiser le texte de l'icône de notification
    Call AffIconeNotifSRV(Me.Form, dtuEtatSyst.EtatSrv.Etat)        ' Indicateur d'état du serveur.
End Sub

' Démarrage du serveur SMTP. Il commence à scanner la BoiteMail.
Sub Demarrer()
    Dim bVersTbl As Byte, i As Integer

    Call RAZEtat

    Call AffIconeNotifSRV(Me.Form, lmlSrvExecCmd)                   ' Indicateur d'état du serveur.

    ' Ecrit l'événement de démarrage dans le journal
    Call Journal(Traduit("¤smtp_logtitre", "libMAIL version %s. Le serveur SMTP démarre.", VersionProg()))
    On Error Resume Next
    bVersTbl = CurrentDb.TableDefs(TableMail()).Properties!VersTbl
    On Error GoTo 0
    Call Journal(Traduit("¤smtp_logtblver", "------ Version de la table %s : %s", TableMail(), bVersTbl))
    Call Journal(Traduit("¤smtp_loginterv", "------ Intervalle de scrutation : %s mn.", dtuEtatSyst.Serveur.DelaiVerif))
    Call Journal(Traduit("¤smtp_logdelai", "------ Délai de réponse ....... : %s s.", dtuEtatSyst.Serveur.DelaiReponse))
    Call Journal(Traduit("¤smtp_logaccessver", "------ Version de MS-Access ... : %s", VersionXS()))
    Call Journal(Traduit("¤smtp_logwindowsver", "------ Version de Windows ..... : %s", VersionWin()))
    Call Journal(Traduit("¤smtp_logplateforme", "------ Plateforme ............. : %s", Plateforme()))
    i = GetUserDefaultLangID()
    Call Journal(Traduit("¤smtp_logsystemlang", "------ Langue du système ...... : %s - %s", i, LangueSyst(i)))
    Call Journal(Traduit("¤smtp_logempljnal", "------ Emplacement du journal . : [%s]\n", dtuEtatSyst.Journal.FichierJnl))

    Me.TimerInterval = 500                                          ' Démarre dans 0.5 seconde.
End Sub

' Suspendre le serveur
Sub Arreter()
    dtuEtatSyst.EtatSrv.ScrutSvte = 0                               ' Pas de nouvelle scrutation prévue.
    Me.TimerInterval = 0
    Call AffIconeNotifSRV(Me.Form, lmlSrvSuspendu)                  ' Indicateur d'état du serveur.

    Call Journal(Traduit("¤smtp_arreter", "Le serveur SMTP est suspendu.")) ' Ecrit l'événement d'arrêt dans le journal
End Sub

' Relance le Timer après une suspension.
Sub Relancer()
    Call RAZEtat

    Me.TimerInterval = dtuEtatSyst.Serveur.DelaiVerif * 60000       ' Rétablir le délai de scrutation, en millisecondes.
    ' Heure de la prochaine scrutation.
    dtuEtatSyst.EtatSrv.ScrutSvte = DateAdd("s", dtuEtatSyst.Serveur.DelaiVerif * 60, Now())
    Call AffIconeNotifSRV(Me.Form, lmlSrvAttente)                   ' Indicateur d'état du serveur.

    Call Journal(Traduit("¤smtp_relancer", "Le serveur SMTP redémarre.")) ' Ecrit l'événement d'arrêt dans le journal
End Sub

' Envoi (presque) immédiat.
Sub Envoyer()
    Call RAZEtat

    Me.TimerInterval = 100
    Call AffIconeNotifSRV(Me.Form, lmlSrvExecCmd)                   ' Indicateur d'état du serveur.
End Sub
' *****************************************************************************************************




' Procède à l'expédition des mails en attente.
Private Sub EnvoieTout()
    Dim rs As DAO.Recordset, iErreur As Integer, i As Integer, lLng As Long, sCmd As String, sCorps As String, dDateEnvoi As Date
    Dim iUCC As Integer, Ppte As DAO.Property, lLnCorps As Long

    ' Liste des mails en attente.
    Set rs = CurrentDb.OpenRecordset("SELECT * FROM " & TableMail() & " WHERE Etat='E' AND Nz(Differer,0) < " & Format$(Now(), "\#mm-dd-yyyy hh:nn:ss\#"), _
                                     dbOpenDynaset)

    ' Déterminer si la compression Unicode est activée (à partir d'Access 2000)
    ' iUCC = -1 : la compression est activée
    '         0 : la compression n'est pas activée
    '         1 : non applicable (avant Access 2000)
    iUCC = 1
    For Each Ppte In rs.Fields!CorpsMsg.Properties
        If Ppte.Name = "UnicodeCompression" Then iUCC = Ppte.Value
    Next Ppte

    ' On détermine ici le volume TOTAL à envoyer.
    Do While Not rs.EOF
        ' FieldSize est beaucoup plus rapide que Len() pour obtenir la taille d'un champ Mémo.
        Select Case iUCC
            Case -1     ' Lorsque la compression est activée, les caractères sont codés sur 1 ou 2 octets. Il faut passer par Len()
                lLnCorps = Len(rs!CorpsMsg)
            Case 0      ' La compression n'est pas activée (mais la propriété existe). On divise par 2.
                lLnCorps = rs!CorpsMsg.FieldSize \ 2
            Case 1      ' La propriété n'existe pas (avant Access 2000)
                lLnCorps = rs!CorpsMsg.FieldSize
        End Select

        lLng = lLng + Len(MSGEnTete(rs, ESMTP_MSG, , Now())) + lLnCorps + 2 ' Compter aussi le vbCrLf final.

        rs.MoveNext
    Loop

    With dtuEtatSyst.EtatSrv
        .OctetsTotal = lLng                                         ' Volume des corps de messages.
        .EnvoiDebut = Now()                                         ' Heure de début d'envoi.
    End With

    If rs.RecordCount > 0 Then rs.MoveFirst
    Do While Not rs.EOF And Not dtuEtatSyst.Serveur.Annule          ' Boucler sur les messages en attente, sauf si Annulation demandée.

        Call Journal(Traduit("¤Envoi du message %s du %s à %s", rs!Identifiant, rs!DateMsg, rs!Destinataires))

        ' Compter les messages.
        dtuEtatSyst.EtatSrv.MessageEnCours = dtuEtatSyst.EtatSrv.MessageEnCours + 1

        dDateEnvoi = Now()                                          ' Date et heure de l'envoi (de création du corps...).
        sCorps = MSGEnTete(rs, ESMTP_MSG, , dDateEnvoi) & rs!CorpsMsg ' Prépare le message et récupère les options étendues.
        lLng = Len(sCorps)                                          ' Taille du message.

        ' MAIL FROM utilise Envoyeur (Sender) ou, s'il est vide, la première adresse de Expediteur.
        sCmd = "MAIL FROM:<"                                        ' Commande de base.
        If Len(ESMTP_MSG.ORG.Envoyeur) = 0 Then
            sCmd = sCmd & Scinder(rs!Expediteur, DELIM)(0)
        Else
            sCmd = sCmd & ESMTP_MSG.ORG.Envoyeur
        End If
        sCmd = sCmd & ">"

        ' ***** Gestion des commandes étendues ***********************************************************
        If ESMTP_SRV.SIZE <> 0 Then                                 ' Si l'extension SIZE est gérée.
            sCmd = sCmd & " SIZE=" & lLng
        End If
        If ESMTP_SRV.DSN Then                                       ' Si le serveur distant reconnaît DSN.
            If ESMTP_MSG.DSN.Retour <> lmlESMTPDsnRetDefaut Then    ' Si un type de retour est spécifié.
                sCmd = sCmd & " RET=" & Choose(ESMTP_MSG.DSN.Retour, "HDRS", "FULL")
                If Len(ESMTP_MSG.DSN.IDEnveloppe) <> 0 Then sCmd = sCmd & " ENVID=" & Left$(Enc_XText(ESMTP_MSG.DSN.IDEnveloppe, True), 94)
            End If
        End If
        ' ================================================================================================

        iErreur = EnvoiCMD(lSock, sCmd)
        If iErreur <> 2 Then GoTo Erreur_Comm

        iErreur = ListeDestinataires(rs)                            ' Traitement de la liste des destinataires.
        If iErreur = 0 Then GoTo Erreur_Comm


        iErreur = EnvoiCMD(lSock, "DATA")
        If iErreur <> 3 Then GoTo Erreur_Comm

        iErreur = EnvoieCorps(lSock, sCorps)
        If iErreur <> REP_AUCUNE Then GoTo Erreur_Comm

        iErreur = EnvoiCMD(lSock, ".")                              ' Finir le mail <CRLF>.<CRLF>
        If iErreur <> 2 Then GoTo Erreur_Comm


        rs.Edit
        rs!Etat = "V"                                               ' Marquer comme 'Envoyé'
        rs!DateEnvoi = dDateEnvoi                                   ' Date et heure de l'envoi.
        rs.Update
        GoTo Message_Suivant

Erreur_Comm:
        ' Si erreur, on décrémente le compteur de messages
        dtuEtatSyst.EtatSrv.MessageEnCours = dtuEtatSyst.EtatSrv.MessageEnCours - 1
        Select Case iErreur
            Case 4                                                  ' Erreur temporaire
                i = EnvoiCMD(lSock, "RSET")

            Case 5, 0                                               ' Erreur permanente/Aucun destinataire valide,
                rs.Edit
                rs!Etat = "X"                                       ' Le message ne sera plus envoyé.
                rs.Update
                Call Journal(Traduit("¤smtp_etinvalide", " X  Ce message a été invalidé. libMAIL ne tentera plus de l'envoyer."))
                i = EnvoiCMD(lSock, "RSET")

            Case REP_DELAI, SOCKET_ERROR                            ' Erreur IP. Ne rien tenter d'autre et sortir.
                Call AffMsgNotif(Traduit("smtp_etreseau", "Erreur réseau ou dépassement de délai d'attente."), NIIF_ERROR)
                Exit Do

            Case Else
                Call Journal(Traduit("¤smtp_eterreur", "*** Erreur <%s> non gérée !", i))

        End Select

Message_Suivant:
        Call Journal(Traduit("¤smtp_etfinmsg", "Fin du message %s ******\n", rs!Identifiant))

        rs.MoveNext
    Loop
    rs.Close
    Set rs = Nothing

    dtuEtatSyst.EtatSrv.EnvoiFin = Now()                            ' Heure de fin de l'envoi.

    ' Afficher une bulle de notification.
    i = dtuEtatSyst.EtatSrv.MessagesTotal - dtuEtatSyst.EtatSrv.MessageEnCours
    If i = 0 Then
        Call AffMsgNotif(Traduit("smtp_etfinok", "Tous les messages ont été envoyés."), NIIF_INFO)
    Else
        Call AffMsgNotif(Traduit("smtp_etfinerr", "%s erreur(s) lors de l'envoi des messages.\n" & _
                             "Consultez le journal de connexion pour en connaître la cause.", i), NIIF_ERROR)
    End If
End Sub

' Traite la liste des destinataires.
' Retourne le nombre de destinataires traités
' Les délimiteurs peuvent être : ;,
Private Function ListeDestinataires(rsMail As DAO.Recordset) As Integer
    Dim s As String, i As Long, iNbDest As Integer, iDestNV As Integer, sCmd As String
    Dim tDests As Variant

    ' Concaténer tous les destinataires pour le traitement, et les récupérer dans un tableau.
    tDests = Scinder(Delims(rsMail!Destinataires & ";" & rsMail!cc & ";" & rsMail!BCC), DELIM)

    ' Traitement des destinataires.
    For i = 0 To UBound(tDests)
        s = Trim$(tDests(i))                                        ' Sortir un destinataire
        If Len(s) <> 0 Then                                         ' Si pas vide
            iDestNV = iDestNV + 1
            sCmd = "RCPT TO:<" & s & ">"                            ' Commande de base

            ' ***** Gestion des commandes étendues *******************************************************
            If ESMTP_SRV.DSN Then                                   ' Si le serveur distant reconnaît DSN
                If ESMTP_MSG.DSN.Notification <> lmlESMTPDsnNotifDefaut Then        ' Si notification demandée
                    sCmd = sCmd & " NOTIFY=" & fNOTIFY(ESMTP_MSG.DSN.Notification)  ' Type de notification demandée
                    sCmd = sCmd & " ORCPT=rfc822;" & s
                End If
            End If
            ' ============================================================================================

            If EnvoiCMD(lSock, sCmd) = 2 Then
                iNbDest = iNbDest + 1                               ' Destinataire accepté.
            Else
                ' Destinataire rejeté.
                Call Journal(Traduit("¤smtp_destrej", "*** Ce destinataire a été rejeté par le serveur distant."))
            End If
        End If
    Next i

    If iNbDest <> iDestNV Or iNbDest = 0 Then                       ' Tous les destinataires 'non-vides' ont-ils été acceptés ?
        i = i - 1
        s = Traduit("smtp_desterr", "%s destinataire(s) sur %s invalide(s).", i - iNbDest, i)
        Call AffMsgNotif(s, NIIF_WARNING)
        Call Journal("*** " & s)
    End If

    ListeDestinataires = iNbDest
    Erase tDests
End Function

' Crée et envoie le corps de message (partie DATA).
' Toutes ces commandes n'attendent pas de retour du serveur.
Private Function EnvoieCorps(lSock As Long, sDonnees As String) As Integer
    Dim d As Long, f As Long, i As Integer, bLog As Boolean

    ' Taille des paquets à envoyer.
    Const Tampon As Long = 524288                                   ' Paquets de 512 Kio
'    Const Tampon As Long = 262144                                   ' Paquets de 256 Kio
'    Const Tampon As Long = 131072                                   ' Paquets de 128 Kio
'    Const Tampon As Long = 65536                                    ' Paquets de 64 Kio

    ' Sauvegarder la valeur du flag LogComm.
    With dtuEtatSyst.Journal
        bLog = .LogComm
        .LogComm = .LogData
    End With


    d = 1: f = Tampon                                               ' Pointeurs début et fin de bloc.

    Do
        f = InStrFin(sDonnees, vbCrLf, f)                           ' Chercher le premier CRLF avant la longueur de tampon.
        If f < d Then f = Len(sDonnees) + 1                         ' Occurrence non trouvée ou trouvée avant 'd'.

        i = EnvoiCMD(lSock, Mid$(sDonnees, d, f - d), REP_AUCUNE)   ' Envoyer le paquet. Le CRLF est rajouté par EnvoiCMD.

        If i = SOCKET_ERROR Or i = REP_DELAI Then Exit Do           ' Une erreur s'est produite. On sort.

        dtuEtatSyst.EtatSrv.OctetsEnvoyes = dtuEtatSyst.EtatSrv.OctetsEnvoyes + f - d + 2      ' Octets envoyés + CRLF

        If dtuEtatSyst.Serveur.Annule And dtuEtatSyst.EtatSrv.Etat <> lmlSrvAnnulation Then    ' Annulation de l'envoi demandée.
            Call AffIconeNotifSRV(Me.Form, lmlSrvAnnulation)        ' Affiche l'icône d'annulation.
            Call AffMsgNotif(Traduit("smtp_ecannul", "Annulation de l'envoi. Le message en cours se termine."), NIIF_WARNING)
            Call Journal(Traduit("¤smtp_ecannul1", "*** L'envoi a été annulé par l'utilisateur."))
        End If

        d = f + 2                                                   ' Déplacer les pointeurs.
        f = d + Tampon
    Loop While d < Len(sDonnees)

    ' Restaurer la valeur du flag LogComm.
    dtuEtatSyst.Journal.LogComm = bLog

    EnvoieCorps = i                                                 ' Remonter l'erreur.
End Function

' Extrait les infos ESMTP de la chaine de connexion.
Private Function fESMTP(sCmd As String) As tuESMTP_EXT_SRV
    Dim i As Integer, tOptions As Variant

    With fESMTP
        .AUTH.LOGIN = sCmd Like "*250[- ]AUTH*LOGIN*"               ' Authentification de type LOGIN
        .AUTH.PLAIN = sCmd Like "*250[- ]AUTH*PLAIN*"               ' Authentification de type PLAIN
        .AUTH.CRAMMD5 = sCmd Like "*250[- ]AUTH*CRAM-MD5*"          ' Authentification de type CRAM-MD5
        .AUTH.DIGESTMD5 = sCmd Like "*250[- ]AUTH*DIGEST-MD5*"      ' Authentification de type DIGEST-MD5
        .AUTH.STARTTLS = sCmd Like "*250[- ]STARTTLS*"              ' Authentification de type STARTTLS
        .DSN = sCmd Like "*250[- ]DSN*"                             ' Accusés de réception
    End With

    i = InStr(sCmd, "SIZE")
    If i <> 0 Then
        tOptions = Scinder(Mid$(sCmd, i + 5, 25), vbCrLf, 2)
        ' Limiter à 2 GiO (suite à une erreur avec Numéricable, qui annonce un SIZE à 88057666386).
        fESMTP.SIZE = IIf(Val(tOptions(0)) > &H7FFFFFFF, &H7FFFFFFF, Val(tOptions(0)))
        Erase tOptions
    End If
End Function

' Tente de s'authentifier auprès du serveur.
' Retourne le code de retour du serveur distant.
Private Function Authentification() As Integer
    Dim i As Integer, s As String, bNonSupportee As Boolean, v As Variant, sRepSrv As String, l As Long

    i = 2                                                           ' Renvoyer Succès par défaut, pour tenter de continuer la session

    With dtuEtatSyst.Serveur.OptionsESMTP.AUTH
        Select Case .Methode                                        ' Selon la méthode d'authentification demandée
            Case lmlESMTPAuthAucune                                 ' Aucune authentification demandée

            Case lmlESMTPAuthLogin                                  ' Authentification de type LOGIN
                If ESMTP_SRV.AUTH.LOGIN Then                        ' Si LOGIN est prise en charge par le serveur
                    i = EnvoiCMD(lSock, "AUTH LOGIN")
                    If i = 3 Then                                   ' Commande acceptée
                        i = EnvoiCMD(lSock, Enc_Base64(.Utilisateur), , False)
                        If i = 3 Then                               ' Nom d'utilisateur accepté
                            i = EnvoiCMD(lSock, Enc_Base64(.MotDePasse), , False)
                        End If
                    End If
                Else
                    bNonSupportee = True
                End If

            Case lmlESMTPAuthPlain                                  ' Authentification de type PLAIN
                If ESMTP_SRV.AUTH.PLAIN Then                        ' Si PLAIN est prise en charge par le serveur
                    i = EnvoiCMD(lSock, "AUTH PLAIN")
                    If i = 3 Then
                        ' Prépare la chaîne d'authentification
                        s = Enc_Base64(vbNullChar & .Utilisateur & vbNullChar & .MotDePasse)
                        i = EnvoiCMD(lSock, s, , False)
                    End If
                Else
                    bNonSupportee = True
                End If

            Case lmlESMTPAuthCRAMMD5                                ' Authentification de type CRAM-MD5
                If ESMTP_SRV.AUTH.CRAMMD5 Then                      ' Si CRAM-MD5 est prise en charge par le serveur
                    i = EnvoiCMD(lSock, "AUTH CRAM-MD5", , , sRepSrv)
                    If i = 3 Then
                        Call Log_DIGEST_MD5(Dec_Base64(Mid$(sRepSrv, 5))) ' Inscrire dans le journal.

                        ' Prépare la chaîne d'authentification
                        s = CRAM_MD5(sRepSrv)
                        i = EnvoiCMD(lSock, s)
                        Call Log_DIGEST_MD5(Dec_Base64(s))          ' Inscrire dans le journal.

                    End If
                Else
                    bNonSupportee = True
                End If

            Case lmlESMTPAuthDIGESTMD5                              ' Authentification de type DIGEST-MD5
                If ESMTP_SRV.AUTH.DIGESTMD5 Then                    ' Si DIGEST-MD5 est prise en charge par le serveur
                    i = EnvoiCMD(lSock, "AUTH DIGEST-MD5", , , sRepSrv)
                    If i = 3 Then
                        Mid$(sRepSrv, 1, 3) = "   "                 ' Retirer le code numérique de la réponse.
                        Call Log_DIGEST_MD5(Dec_Base64(sRepSrv))    ' Inscrire dans le journal la réponse 'en clair'.

                        ' Prépare la chaîne d'authentification
                        s = DIGEST_MD5(sRepSrv)

                        If Len(s) <> 0 Then
                            i = EnvoiCMD(lSock, Enc_Base64(s, 0), , , sRepSrv)  ' Envoyer la réponse, encodée en Base64.
                            Call Log_DIGEST_MD5(s)                  ' Inscrire dans le journal la réponse 'en clair'.

                            If i = 3 Then
                                Mid$(sRepSrv, 1, 3) = "   "         ' Retirer le code numérique de la réponse.
                                Call Log_DIGEST_MD5(Dec_Base64(sRepSrv))

                                i = EnvoiCMD(lSock, "")  ' Envoyer une réponse vide
                            End If

                        Else
                            i = 5                                   ' Erreur fatale
                            Call Journal(Traduit("¤smtp_autherrmd5", "*** Erreur lors de l'authentification DIGEST-MD5."))

                        End If
                    End If
                Else
                    bNonSupportee = True
                End If

            Case Else
                bNonSupportee = True                                ' Non supportée par libMAIL

        End Select

        ' Journalisation
        If bNonSupportee Then
            v = NomMethodeAuth(.Methode)
            If IsNull(v) Then
                Call Journal(Traduit("¤smpt_autherrmeth1", "*** La méthode d'authentification [%s] n'est pas prise en charge par libMAIL.", .Methode))
            Else
                Call Journal(Traduit("¤smpt_autherrmeth2", "*** L'authentification '%s' n'est pas prise en charge par %s.", v, dtuEtatSyst.Serveur.NomSrv))
            End If
            Call Journal(Traduit("¤smtp_authnometh", "*** Tentative d'envoi sans authentification."))
        End If
    End With

    Authentification = i                                            ' Code de retour
End Function

' Retourne une chaîne contenant la liste des notifications demandées pour la commande RCPT
Private Function fNOTIFY(iNotif As Integer) As String
    If iNotif = lmlESMTPDsnNotifJamais Then
        fNOTIFY = "NEVER"

    Else
        If (iNotif And lmlESMTPDsnNotifSucces) = lmlESMTPDsnNotifSucces Then fNOTIFY = "SUCCESS"

        If (iNotif And lmlESMTPDsnNotifEchec) = lmlESMTPDsnNotifEchec Then
            If Len(fNOTIFY) <> 0 Then fNOTIFY = fNOTIFY & ","
            fNOTIFY = fNOTIFY & "FAILURE"
        End If

        If (iNotif And lmlESMTPDsnNotifDelai) = lmlESMTPDsnNotifDelai Then
            If Len(fNOTIFY) <> 0 Then fNOTIFY = fNOTIFY & ","
            fNOTIFY = fNOTIFY & "DELAY"
        End If

    End If
End Function

' Active/désactive une option de menu en fonction de l'état du serveur
' et de la variable d'état du menu.
Private Sub MenuOnOff(iIDOption As Integer, iEtatSrv As Boolean)
    Dim cbc As CommandBarControl

    ' Trouver l'option de menu, recherche sur le Tag
    Set cbc = Application.CommandBars("CB_libMAIL").FindControl(, , iIDOption)
    If Not cbc Is Nothing Then                                      ' L'option a été trouvée
        ' (Dés)activé, en fonction de l'état du serveur et de l'autorisation de l'option de menu)
        cbc.Enabled = (iEtatSrv And ((dtuEtatSyst.Tray.EtatMenu And iIDOption) = 0))

        Set cbc = Nothing
    End If
End Sub

' RAZ de la variable d'état du serveur, en préservant le membre Etat.
Private Sub RAZEtat()
    Dim bEtat As Byte

    bEtat = dtuEtatSyst.EtatSrv.Etat
    dtuEtatSyst.EtatSrv = dtuEtatSRV_RAZ
    dtuEtatSyst.EtatSrv.Etat = bEtat
End Sub

' Incrire le détail DIGEST-MD5 dans le journal.
Private Sub Log_DIGEST_MD5(sChaine As String)
    Const csRempl As String = vbCrLf & "        "
    
    ' Evite le traitement Remplacer si on ne journalise pas.
    If Not dtuEtatSyst.Journal.LogComm Then Exit Sub

    Call Journal(csRempl & Remplacer(sChaine, ",", csRempl) & vbCrLf)
End Sub
'
'
' ********************************************************************************************************************************************



' Evénement utilisé pour la gestion du menu de l'icône de la zone de notification.
Private Sub Détail_MouseMove(Button As Integer, Shift As Integer, x As Single, y As Single)
    Dim lEvent As Long

    lEvent = (x \ TwipsPerPixelX()) - 1                             ' Récupérer l'événement de souris.
    ' Afficher le menu à la position de la souris.
    If lEvent = WM_RBUTTONUP Then                                   ' Si clic avec le bouton droit
        With dtuEtatSyst.EtatSrv
            Call MenuOnOff(lmlMnuSspn, (.Etat = lmlSrvAttente))     ' Suspendre
            Call MenuOnOff(lmlMnuRlnc, (.Etat = lmlSrvSuspendu))    ' Relancer
            Call MenuOnOff(lmlMnuEnvM, (.Etat = lmlSrvAttente))     ' Envoyer maintenant
            Call MenuOnOff(lmlMnuDech, ((.Etat <> lmlSrvEnCours) And _
                                        (.Etat <> lmlSrvConnexion)))    ' Décharger
            Call MenuOnOff(lmlMnuAnnE, ((.Etat = lmlSrvEnCours) Or _
                                        (.Etat = lmlSrvConnexion)))     ' Annuler l'envoi
        End With

        ' Ces options ne dépendent pas de l'état du serveur.
        Call MenuOnOff(lmlMnuNMsg, True)                            ' Nouveau message
        Call MenuOnOff(lmlMnuGest, True)                            ' Gestionnaire
        Call MenuOnOff(lmlMnuEtat, True)                            ' Afficher l'état
        Call MenuOnOff(lmlMnuAJnl, True)                            ' Afficher le journal

        Call SetForegroundWindow(Me.hwnd)
        ' Si la bibliothèque est en MDE, et que la fenêtre de l'application hôte est réduite
        ' dans la barre des tâches, Access génère une erreur lors du clic droit sur l'icône...
        ' Et pourtant, Err.Number retourne 0... ?
        On Error Resume Next
        Application.CommandBars("CB_libMAIL").ShowPopup             ' Afficher le menu contextuel.
        On Error GoTo 0
    End If
End Sub

Private Sub Form_Load()
    Call CreeMenu                                                   ' Créer le menu contextuel dans l'application principale

    Me.TimerInterval = 0                                            ' Suspendre à l'ouverture
    Call AffIconeNotifSRV(Me.Form, lmlSrvSuspendu)                  ' Indicateur d'état du serveur.
End Sub

' L'événement Timer est utilisé pour déclencher régulièrement la scrutation de la table BoiteMail,
' et l'envoi d'éventuels messages en attente.
Private Sub Form_Timer()
    Dim i As Integer, sRepSrv As String, lRet As Long, s As String, bCnxOK As Boolean

    Call RAZEtat

    i = NbMails()                                                   ' Nombre de messages en attente d'envoi.

    Call Journal(Traduit("¤smtp_tmrdebut", "Scrutation démarrée sur %s\n", UCase$(myComputerName())))
    Call Journal(Traduit("¤smtp_tmrnmsg", "Il y a %s message(s) en attente.", i))
    If i = 0 Then GoTo Fin_du_serveur

    dtuEtatSyst.EtatSrv.MessagesTotal = i

    ' Arrêt du Timer pendant le traitement, pour éviter toute 'collision' si
    ' le traitement est plus long que l'intervalle de déclenchement.
    Me.TimerInterval = 0

    ' Indicateur d'état du serveur.
    Call AffIconeNotifSRV(Me.Form, lmlSrvConnexion)

    ' Etablir la connexion au serveur/port. Retourne le socket obtenu.
    lRet = CnxServ(dtuEtatSyst.Serveur.NomSrv, dtuEtatSyst.Serveur.PortSrv, lSock)
    If lRet <> 0 Then GoTo Fermeture_Socket


    ' N'envoie rien, attend la confirmation de connexion du serveur
    If EnvoiCMD(lSock, Null) <> 2 Then GoTo Fermeture_Socket

    ' La partie Réseau est faite.
    ' Maintenant commence le protocole SMTP
    ' *************************************
    With dtuEtatSyst.Serveur
        If EnvoiCMD(lSock, "EHLO " & .HELOdomain, , , sRepSrv) <> 2 Then  ' Tentative avec les extensions.
            If EnvoiCMD(lSock, "HELO " & .HELOdomain) <> 2 Then     ' Repli sur connexion sans extension.
                GoTo Fermeture_Socket
            End If
        Else
            ' Cas d'un serveur pour lequel la réponse n'est pas reçue en une seule fois...
            ' (mail.paris.delosmail.com)
            Do While Not sRepSrv Like "*250 *"
                s = ""
                Call EnvoiCMD(lSock, Null, , , s)
                sRepSrv = sRepSrv & s
            Loop

            ESMTP_SRV = fESMTP(sRepSrv)                             ' Extraire les extensions SMTP de la réponse.

        End If
    End With

    ' Gestion de l'authentification
    If Not Authentification() Like "[23]" Then GoTo Fermeture_Session


    ' Si une annulation a été demandée pendant la phase de connexion
    If dtuEtatSyst.Serveur.Annule Then
        Call AffIconeNotifSRV(Me.Form, lmlSrvAnnulation)
        GoTo Fermeture_Session
    End If


    ' La connexion s'est effectuée avec succès, on peut maintenant envoyer.
    bCnxOK = True

    ' Débuter l'envoi.
    Call AffIconeNotifSRV(Me.Form, lmlSrvEnCours)                   ' Indicateur d'état du serveur.
    Call EnvoieTout                                                 ' Envoie tous les messages en attente.

Fermeture_Session:
    ' Envoyer QUIT
    i = EnvoiCMD(lSock, "QUIT")
    ESMTP_SRV = ESMTP_SRV_RAZ                                       ' RàZ variable ESMTP.

Fermeture_Socket:
    Call CnxFin(lSock)


Fin_du_serveur:
    dtuEtatSyst.Serveur.Annule = False                              ' RAZ du drapeau d'annulation.

    ' Déterminer le membre Resultat
    With dtuEtatSyst.EtatSrv
        If bCnxOK Then                                              ' Si connexion OK.
            Select Case .MessagesTotal
                Case 0
                    .Resultat = lmlSrvResRien                       ' Rien à envoyer.

                Case Else
                    Select Case .MessageEnCours
                        Case .MessagesTotal:    .Resultat = lmlSrvResOK     ' Tout envoyé.
                        Case Else:              .Resultat = lmlSrvResErr    ' Envoi partiel.
                    End Select

            End Select

        Else
            .Resultat = lmlSrvResCnx                                ' Erreur de connexion ou d'authentification.

        End If
    End With

    ' Quitter le serveur à la fin de l'envoi ?
    If dtuEtatSyst.Serveur.EnvoiQuitte Then
        DoCmd.Close acForm, Me.Name, acSaveNo

    Else
        With dtuEtatSyst.EtatSrv
            .ScrutSvte = DateAdd("n", dtuEtatSyst.Serveur.DelaiVerif, Now()) ' Scrutation suivante.
        End With
        Call AffIconeNotifSRV(Me.Form, lmlSrvAttente)               ' Indicateur d'état du serveur.

        Call Journal(Traduit("¤smtp_tmrscansvt", "Prochaine vérification : %s", dtuEtatSyst.EtatSrv.ScrutSvte))
        Call Journal(String(80, "*") & vbCrLf & vbCrLf)

        Me.TimerInterval = dtuEtatSyst.Serveur.DelaiVerif * 60000   ' Rétablir la temporisation (convertir de minutes en millisecondes)
    End If
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Call Journal(Traduit("¤smtp_frmuload", "Déchargement du serveur."))
    Call Journal(String(80, "*") & vbCrLf & vbCrLf)

    With dtuEtatSyst.EtatSrv
        .Etat = lmlSrvDecharge                                      ' Indicateur d'état du serveur.
        .ScrutSvte = 0                                              ' Pas de nouvelle scrutation prévue.
    End With

    With dtuEtatSyst.Tray
        Shell_NotifyIcon NIM_DELETE, .nid                           ' Retirer l'icône
        Call DestroyIcon(.nid.hIcon)                                ' Détruire l'icône.

        ' RAZ des pointeurs vers le formulaire et vers l'icône, car ils ne sont plus valides.
        .nid.hIcon = &H0&
        .nid.hwnd = &H0&
    End With
End Sub